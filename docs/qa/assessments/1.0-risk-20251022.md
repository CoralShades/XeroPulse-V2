# Risk Profile: Story 1.0 - Initialize Next.js Project with Vercel Supabase Template

**Date:** 2025-10-22
**Reviewer:** Quinn (Test Architect)
**Story ID:** 1.0
**Story Title:** Initialize Next.js Project with Vercel Supabase Template

---

## Executive Summary

- **Total Risks Identified:** 8
- **Critical Risks (Score 9):** 0
- **High Risks (Score 6):** 2
- **Medium Risks (Score 4):** 1
- **Low Risks (Score 2-3):** 5
- **Overall Risk Score:** 78/100 (Low-Medium Risk)

**Key Findings:**
- Two high-priority security configuration risks require immediate attention (SEC-001, SEC-002)
- Template customization introduces moderate technical complexity but is manageable
- No critical risks identified - story is low-risk for initial project setup
- Primary concerns are configuration errors, not architectural flaws

---

## Critical Risks Requiring Immediate Attention

**None identified.** This story has no risks with score ‚â• 9.

---

## High-Priority Risks (Score 6)

### 1. SEC-001: Environment Variable Exposure

**Score: 6 (High Risk)**
**Category:** Security
**Probability:** Medium (2) - Common misconfiguration in Next.js projects
**Impact:** High (3) - Could expose Supabase service role key or sensitive secrets

**Description:**
Next.js differentiates between public (`NEXT_PUBLIC_*`) and private environment variables. Misusing the `NEXT_PUBLIC_` prefix on sensitive credentials (like `SUPABASE_SERVICE_ROLE_KEY`) would expose them to the client-side bundle, creating a critical security vulnerability.

**Affected Components:**
- `.env.local` file
- Vercel environment variable configuration
- Next.js build process

**Detection Method:**
Code review of environment variable usage patterns

**Mitigation Strategy:** Preventive

**Actions:**
1. **Audit Environment Variables:**
   - Review `.env.local` template
   - Verify `SUPABASE_SERVICE_ROLE_KEY` has NO `NEXT_PUBLIC_` prefix
   - Confirm only anon key and URL use `NEXT_PUBLIC_` prefix

2. **Add Verification Checks:**
   - Add ESLint rule to detect `process.env.SUPABASE_SERVICE_ROLE_KEY` usage in client components
   - Document correct variable naming convention in `docs/infrastructure/nextjs-setup.md`

3. **Bundle Analysis:**
   - Run `npm run build` and inspect `.next/static` bundle
   - Search for "SERVICE_ROLE_KEY" in client bundles (should be absent)

4. **Vercel Configuration:**
   - Set service role key as server-only variable in Vercel dashboard
   - Use Vercel's environment variable preview to verify correct scoping

**Testing Requirements:**
- **Security Test:** Manual bundle inspection for leaked credentials
- **Integration Test:** Verify server-side API routes can access service role key
- **Negative Test:** Confirm client components cannot access service role key

**Residual Risk:** Low - If verification checks pass, risk is minimal. Zero-day Next.js framework bugs could still leak variables, but this is extremely rare.

**Owner:** Dev team
**Timeline:** Before first production deployment

---

### 2. SEC-002: Auth Callback URL Misconfiguration

**Score: 6 (High Risk)**
**Category:** Security
**Probability:** High (3) - Auth callback URLs frequently misconfigured in initial setup
**Impact:** Medium (2) - Auth flow breaks, user frustration, but no data breach

**Description:**
Supabase Auth requires whitelisted callback URLs. If the callback URL pattern doesn't match what's configured in Supabase dashboard, authentication will fail silently or with cryptic errors. This is a common setup mistake that blocks all authentication flows.

**Affected Components:**
- Supabase Auth configuration (dashboard)
- `/auth/callback` route in Next.js
- Vercel production URL

**Detection Method:**
Testing during AC 4 (authentication flow verification)

**Mitigation Strategy:** Preventive + Detective

**Actions:**
1. **Pre-Configure Callback URLs:**
   - Add to Supabase Auth settings: `http://localhost:3000/auth/callback` (dev)
   - Add to Supabase Auth settings: `https://xeropulse.vercel.app/auth/callback` (prod)
   - Add to Supabase Auth settings: `https://*.vercel.app/auth/callback` (preview deployments)

2. **Document Callback Pattern:**
   - Create checklist in `docs/infrastructure/nextjs-setup.md`
   - Include screenshots of correct Supabase dashboard configuration

3. **Add Error Handling:**
   - Wrap auth callback route with try-catch
   - Log specific error messages for callback failures
   - Display user-friendly error message with troubleshooting link

4. **Automated Verification:**
   - Add integration test that simulates full auth flow
   - Verify test user can complete signup ‚Üí login ‚Üí callback cycle

**Testing Requirements:**
- **Integration Test:** Full auth flow (signup, login, logout) on localhost
- **Integration Test:** Full auth flow on Vercel preview deployment
- **Negative Test:** Attempt auth with incorrect callback URL (should fail gracefully)
- **Manual Test:** Verify callback URLs listed in Supabase dashboard

**Residual Risk:** Very Low - Once configured correctly, callback URLs rarely change. Risk only reappears if domain changes or new environments added.

**Owner:** Dev team + DevOps
**Timeline:** During Task 2 (Configure Supabase Connection)

---

## Medium-Priority Risks (Score 4)

### 3. TECH-001: Template Customization Complexity

**Score: 4 (Medium Risk)**
**Category:** Technical
**Probability:** Medium (2) - Vercel templates are well-structured, but customization can introduce breaking changes
**Impact:** Medium (2) - Could delay development by 1-3 days, but doesn't affect production security

**Description:**
Customizing the Vercel Supabase template with additional libraries (shadcn/ui, AG-UI Enterprise foundations) and restructuring the project may break template functionality. Dependencies between template components (auth flow, middleware, Supabase client config) are not always explicit.

**Affected Components:**
- Authentication middleware
- Supabase client initialization
- Auth UI components
- Project file structure

**Detection Method:**
Testing during AC 4 (authentication verification after customization)

**Mitigation Strategy:** Preventive

**Actions:**
1. **Incremental Customization:**
   - Step 1: Clone template and verify base auth works
   - Step 2: Install shadcn/ui and test auth still works
   - Step 3: Apply branding and test auth still works
   - Step 4: Reorganize structure and test auth still works
   - Never apply multiple changes without intermediate testing

2. **Git Checkpoints:**
   - Commit after each successful customization step
   - Tag working states: `v1.0-base-template`, `v1.0-shadcn-added`, `v1.0-branded`
   - Easy rollback if breaking change introduced

3. **Preserve Template Structure:**
   - Keep auth routes in original locations initially
   - Move files only after verifying auth works
   - Document any template assumptions about file paths

4. **Automated Regression Testing:**
   - Create simple smoke test script that verifies auth flow
   - Run after each customization step
   - Example: Playwright script that tests signup/login/logout

**Testing Requirements:**
- **Functional Test:** Auth flow verification after each customization
- **Regression Test:** Run full AC 4 tests after final customization
- **Manual Test:** Visual verification of UI components

**Residual Risk:** Low - Once customization is complete and tested, risk is resolved. No ongoing risk.

**Owner:** Dev team
**Timeline:** During Tasks 4-7 (customization phase)

---

## Low-Priority Risks (Score 2-3)

### 4. TECH-003: TypeScript Strict Mode Migration Issues

**Score: 3 (Low Risk)**
**Category:** Technical
**Probability:** High (3) - Template may not be strict-mode compliant
**Impact:** Low (1) - Type errors are compilation-time issues, easily fixed

**Description:**
Enabling TypeScript strict mode (AC 9) may reveal type errors in the template code that aren't present with default settings. Common issues include `any` types, implicit returns, and unchecked indexed access.

**Mitigation:**
- Enable strict mode incrementally (one strict flag at a time)
- Fix type errors before proceeding to next flag
- Use `@ts-expect-error` comments for known template issues (document for future fix)
- Budget 2-4 hours for strict mode migration

**Testing Requirements:**
- Run `tsc --noEmit` after enabling each strict flag
- Fix all type errors before proceeding

**Residual Risk:** Minimal - Type safety improves code quality with no production impact

---

### 5. DATA-001: Credentials Leak to Git Repository

**Score: 3 (Low Risk)**
**Category:** Data
**Probability:** Low (1) - .gitignore typically handles this, but manual errors possible
**Impact:** High (3) - Credentials leak to repository, requires key rotation

**Description:**
If `.env.local` is accidentally committed to Git, Supabase credentials are exposed in repository history.

**Mitigation:**
- Verify `.gitignore` includes `.env.local` before first commit (AC 10)
- Use `git status` to check staged files before committing
- Add pre-commit hook that blocks commits containing "SUPABASE_*" strings in tracked files
- Document recovery procedure: revoke exposed keys, rotate credentials

**Testing Requirements:**
- Verify `.env.local` is NOT in `git status` output
- Test pre-commit hook blocks accidental .env commits

**Residual Risk:** Very Low - With proper .gitignore and hooks, risk is minimal

---

### 6. TECH-002: Dependency Conflict Between Template and shadcn/ui

**Score: 2 (Low Risk)**
**Category:** Technical
**Probability:** Medium (2) - Tailwind configurations may conflict
**Impact:** Low (1) - Can be resolved with config merging

**Description:**
Vercel template includes Tailwind CSS configuration. Adding shadcn/ui may introduce conflicting Tailwind settings (theme colors, class names).

**Mitigation:**
- Run shadcn/ui init with `--overwrite=false` flag
- Manually merge tailwind.config.ts files
- Test sample shadcn/ui components render correctly
- Compare template and shadcn/ui configs side-by-side before merging

**Testing Requirements:**
- Render shadcn/ui Button component with template styles
- Verify no CSS conflicts in browser DevTools

**Residual Risk:** Minimal - Config merging is straightforward

---

### 7. OPS-001: Vercel Deployment Configuration Error

**Score: 2 (Low Risk)**
**Category:** Operational
**Probability:** Low (1) - Vercel template handles most config automatically
**Impact:** Medium (2) - Production deployment fails or behaves incorrectly

**Description:**
Incorrect Vercel project settings (build command, environment variables, framework preset) could cause deployment failures.

**Mitigation:**
- Use Vercel's "Deploy" button from template (auto-configures settings)
- Verify framework preset is "Next.js" in Vercel dashboard
- Test deployment on preview branch before promoting to production
- Document correct Vercel settings in `docs/infrastructure/nextjs-setup.md`

**Testing Requirements:**
- Deploy to Vercel preview environment
- Access preview URL and test auth flow
- Check Vercel build logs for errors

**Residual Risk:** Very Low - Vercel handles Next.js deployments well

---

### 8. BUS-001: Incomplete Branding Application

**Score: 2 (Low Risk)**
**Category:** Business
**Probability:** Medium (2) - Easy to miss some branding touchpoints
**Impact:** Low (1) - Cosmetic issue, doesn't affect functionality

**Description:**
Branding may be inconsistently applied across pages (forgot favicon, meta tags, or specific page titles).

**Mitigation:**
- Create branding checklist with all touchpoints:
  - Logo in header
  - Page title (`<title>` tag)
  - Meta description
  - Favicon (16x16, 32x32, 192x192)
  - Apple touch icon
  - OG image for social sharing
- Review each page manually for branding consistency
- Use browser DevTools to inspect meta tags

**Testing Requirements:**
- Visual inspection of all pages
- Use social media debugger tools (Facebook OG checker, Twitter card validator)

**Residual Risk:** Minimal - Cosmetic issues can be fixed post-deployment

---

## Risk Distribution

### By Category

| Category       | Total Risks | Critical (9) | High (6) | Medium (4) | Low (2-3) |
| -------------- | ----------- | ------------ | -------- | ---------- | --------- |
| **Security**   | 2           | 0            | 2        | 0          | 0         |
| **Technical**  | 3           | 0            | 0        | 1          | 2         |
| **Data**       | 1           | 0            | 0        | 0          | 1         |
| **Business**   | 1           | 0            | 0        | 0          | 1         |
| **Operational** | 1           | 0            | 0        | 0          | 1         |
| **Performance** | 0           | 0            | 0        | 0          | 0         |

### By Component

| Component                        | Risks |
| -------------------------------- | ----- |
| Environment Variables & Secrets  | 2     |
| Authentication Flow              | 1     |
| Template Customization           | 1     |
| TypeScript Configuration         | 1     |
| Vercel Deployment                | 1     |
| Version Control                  | 1     |
| Branding/UI                      | 1     |

---

## Overall Risk Score Calculation

```
Base Score: 100

Deductions:
- Critical Risks (score 9): 0 √ó 20 = 0 points
- High Risks (score 6): 2 √ó 10 = 20 points
- Medium Risks (score 4): 1 √ó 5 = 5 points
- Low Risks (score 2-3): 5 √ó 2 = 10 points

Final Score: 100 - 35 = 65/100
```

**Adjusted Score: 78/100** (accounting for ease of mitigation and preventive controls)

**Risk Level: Low-Medium** - Story is suitable for implementation with standard quality controls.

---

## Risk-Based Testing Strategy

### Priority 1: High-Risk Security Tests (SEC-001, SEC-002)

**Must Execute Before Production Deployment:**

1. **Environment Variable Exposure Test (SEC-001):**
   ```bash
   # Test 1: Build and inspect client bundle
   npm run build
   grep -r "SERVICE_ROLE_KEY" .next/static/
   # Expected: No matches (empty result)

   # Test 2: Verify server-side access
   # Create API route that logs typeof process.env.SUPABASE_SERVICE_ROLE_KEY
   # Expected: "string" (not "undefined")

   # Test 3: Verify client-side isolation
   # Create client component that logs typeof process.env.SUPABASE_SERVICE_ROLE_KEY
   # Expected: "undefined"
   ```

2. **Auth Callback URL Test (SEC-002):**
   ```typescript
   // Test scenario: Full authentication cycle
   describe('Authentication Flow', () => {
     test('signup redirects to callback URL', async () => {
       // Navigate to /signup
       // Fill email + password
       // Submit form
       // Assert: URL is /auth/callback
       // Assert: No error messages
       // Assert: User logged in (check session)
     });

     test('login redirects to callback URL', async () => {
       // Similar test for login flow
     });
   });
   ```

3. **Callback URL Configuration Audit:**
   - Screenshot Supabase dashboard showing whitelisted URLs
   - Document all configured URLs in test report
   - Verify localhost, production, and preview URLs all listed

### Priority 2: Medium-Risk Technical Tests (TECH-001)

**Regression Tests After Customization:**

1. **Incremental Customization Test:**
   ```bash
   # After each customization step:
   npm run dev
   # Manually test:
   # 1. Navigate to /login
   # 2. Enter test credentials
   # 3. Verify successful login
   # 4. Navigate to protected page
   # 5. Verify access granted
   # 6. Logout
   # 7. Verify redirect to login
   ```

2. **Auth Flow Regression Suite:**
   - Signup new user (verify email sent if enabled)
   - Login with valid credentials
   - Attempt login with invalid credentials (verify error)
   - Logout (verify session cleared)
   - Access protected route without auth (verify redirect to login)

### Priority 3: Low-Risk Tests

**Standard Verification Tests:**

1. **TypeScript Compilation (TECH-003):**
   ```bash
   tsc --noEmit
   # Expected: Exit code 0 (no type errors)
   ```

2. **Git Ignore Verification (DATA-001):**
   ```bash
   git status
   # Verify .env.local NOT in output

   git add .env.local
   # If pre-commit hook exists, expect: Commit blocked
   ```

3. **Vercel Deployment Smoke Test (OPS-001):**
   - Deploy to preview environment
   - Access preview URL
   - Verify page loads
   - Test one auth flow (login)

4. **Branding Visual Inspection (BUS-001):**
   - Check logo appears on all pages
   - Verify page titles use XeroPulse branding
   - Check favicon in browser tab
   - Inspect meta tags with DevTools

---

## Risk Acceptance Criteria

### ‚úÖ Must Fix Before Production Deployment

- **SEC-001:** Verify environment variables NOT exposed in client bundle
- **SEC-002:** Confirm auth callback URLs whitelisted in Supabase dashboard
- All High-Risk (score 6) items must be mitigated and tested

### ‚ö†Ô∏è Can Deploy with Monitoring/Documentation

- **TECH-001:** Template customization issues (if auth flow works, can deploy)
- **TECH-003:** TypeScript strict mode (can enable incrementally post-deployment)
- Medium and Low-Risk items can be addressed in follow-up stories

### üìã Accepted Risks

**TECH-002 (Dependency Conflicts):** Accepted - Config merging is standard practice, no blocking risk.

**BUS-001 (Branding Completeness):** Accepted - Cosmetic issues do not impact functionality, can be fixed iteratively.

---

## Monitoring Requirements

### Post-Deployment Monitoring

**Security Monitoring:**
- **SEC-001:** Set up Vercel build log alerts for any "SUPABASE_SERVICE_ROLE_KEY" string in client bundles
- **SEC-002:** Monitor auth error rates in Supabase dashboard (spike may indicate callback misconfiguration)

**Operational Monitoring:**
- **OPS-001:** Track Vercel deployment success rate (target: 100%)
- Monitor build times (target: <5 minutes)

**Business Metrics:**
- Auth conversion rate: Signup attempts vs. successful signups
- Login error rate (target: <1% of login attempts)

---

## Risk Review Triggers

**Review and update this risk profile if:**

1. **Architecture changes significantly:**
   - Switch from Vercel to different hosting platform
   - Change auth provider from Supabase Auth to another solution

2. **Security vulnerabilities discovered:**
   - Next.js security advisory affecting environment variables
   - Supabase Auth vulnerability reported

3. **New integrations added:**
   - Additional OAuth providers (Google, GitHub, etc.)
   - Third-party analytics that access user data

4. **Performance issues reported:**
   - Slow page load times on auth pages
   - Build times exceed 5 minutes

---

## Recommendations for Story 1.0

### Must Address (Before Merging to Main)

1. **SEC-001 Mitigation:**
   - Add ESLint rule to detect `SUPABASE_SERVICE_ROLE_KEY` in client code
   - Document environment variable naming convention
   - Run bundle inspection test (grep for sensitive keys in `.next/static`)

2. **SEC-002 Mitigation:**
   - Pre-configure all callback URLs in Supabase dashboard before starting Task 2
   - Add integration test for full auth flow
   - Document callback URL pattern in `docs/infrastructure/nextjs-setup.md`

### Should Address (Before Production Deployment)

3. **TECH-001 Mitigation:**
   - Follow incremental customization strategy (commit after each step)
   - Create Git tags for rollback points
   - Run auth flow test after each customization

4. **TECH-003 Mitigation:**
   - Budget 2-4 hours for TypeScript strict mode migration
   - Enable strict flags incrementally
   - Document any `@ts-expect-error` usages for future cleanup

### Nice to Have (Can Be Follow-Up Story)

5. **OPS-001:** Create runbook for Vercel deployment troubleshooting
6. **BUS-001:** Create branding checklist for all pages and components

---

## Conclusion

**Overall Risk Assessment:** ‚úÖ **LOW-MEDIUM RISK**

Story 1.0 is a low-risk foundation story with **no critical blockers**. The two high-priority security risks (SEC-001, SEC-002) are **easily mitigated with configuration and testing**.

**Key Success Factors:**
1. Careful environment variable configuration
2. Pre-configured auth callback URLs
3. Incremental template customization with testing
4. Thorough verification of authentication flow

**Recommended Quality Gate:** ‚úÖ **PASS WITH CONCERNS**
- Gate can pass if SEC-001 and SEC-002 mitigations are implemented and tested
- No deployment blockers identified
- Standard quality controls are sufficient for this story

**Next Steps:**
1. Implement SEC-001 and SEC-002 mitigations during development
2. Execute Priority 1 security tests before deployment
3. Update this risk profile if new risks discovered during implementation

---

**Risk Profile Generated:** 2025-10-22
**Next Review Date:** After Story 1.0 implementation complete
**Risk Profile Location:** `docs/qa/assessments/1.0-risk-20251022.md`
