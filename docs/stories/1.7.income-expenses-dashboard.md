# Story 1.7: Build Income vs Expenses Dashboard (Dashboard 1)

## Status
**Draft**

## Story
**As a** finance team member,
**I want** an interactive dashboard showing cash flow with income and expense trends,
**So that** I can monitor weekly financial performance and 8-week rolling averages.

## Acceptance Criteria

1. Metabase dashboard created with title "Income vs Expenses"
2. Chart 1: Weekly income trend line (source: Xero Payments API, filtered for invoice payments received)
3. Chart 2: Weekly expenses trend line (source: Xero Payments API, filtered for bill payments made)
4. Chart 3: 8-week rolling average calculation for wages expense (source: Xero Transactions, filtered by account category)
5. Chart 4: 8-week rolling average for general expenses (source: Xero Transactions, aggregated by expense categories)
6. Date range filter widget (default: last 6 months, user-adjustable)
7. KPI cards displaying: Total Income (current period), Total Expenses (current period), Net Cash Flow (Income - Expenses)
8. Dashboard loads in <3 seconds with 6 months of data
9. Visual design: Clean layout, color-coded income (green) vs expenses (red), clear labels and legends
10. "Last updated" timestamp displayed prominently (sourced from `last_sync_at` metadata)
11. Dashboard exported to version control (`/supabase/dashboards/dashboard-1-income-expenses.json`)

## Tasks / Subtasks

- [ ] **Task 1: Create SQL Queries for Charts** (AC: 2, 3, 4, 5)
  - [ ] Write query for weekly income (payments received)
  - [ ] Write query for weekly expenses (payments made)
  - [ ] Write query for 8-week rolling avg wages
  - [ ] Write query for 8-week rolling avg general expenses
  - [ ] Test queries in Metabase SQL editor

- [ ] **Task 2: Create Visualizations** (AC: 2, 3, 4, 5)
  - [ ] Create income trend line chart
  - [ ] Create expenses trend line chart
  - [ ] Create wages rolling average chart
  - [ ] Create general expenses rolling average chart
  - [ ] Configure chart colors (green/red)

- [ ] **Task 3: Create KPI Cards** (AC: 7)
  - [ ] Create "Total Income" metric
  - [ ] Create "Total Expenses" metric
  - [ ] Create "Net Cash Flow" calculated metric
  - [ ] Format as currency (AUD)

- [ ] **Task 4: Add Date Filter** (AC: 6)
  - [ ] Create date range parameter
  - [ ] Set default to last 6 months
  - [ ] Link filter to all charts

- [ ] **Task 5: Design Dashboard Layout** (AC: 9)
  - [ ] Arrange charts in logical layout
  - [ ] Add title and descriptions
  - [ ] Apply color scheme
  - [ ] Test responsive design

- [ ] **Task 6: Add Last Updated Timestamp** (AC: 10)
  - [ ] Query `organizations.last_sync_at`
  - [ ] Display timestamp on dashboard
  - [ ] Format timestamp (e.g., "Last updated: 2025-10-22 14:30")

- [ ] **Task 7: Performance Testing** (AC: 8)
  - [ ] Load dashboard with 6 months data
  - [ ] Measure load time
  - [ ] Optimize slow queries if needed

- [ ] **Task 8: Export Dashboard Configuration** (AC: 11)
  - [ ] Export dashboard JSON from Metabase
  - [ ] Save to `/supabase/dashboards/dashboard-1-income-expenses.json`
  - [ ] Commit to version control

## Dev Notes

### Dashboard Requirements

**Chart Specifications:**
- Income trend: Line chart, X-axis: Week, Y-axis: Income (AUD)
- Expenses trend: Line chart, X-axis: Week, Y-axis: Expenses (AUD)
- Rolling averages: Line charts with 8-week window
- [Source: requirements.md#functional-requirements FR6]

### SQL Query Examples

**Weekly Income:**
```sql
SELECT
  DATE_TRUNC('week', payment_date) AS week,
  SUM(amount) AS total_income
FROM payments
WHERE
  organization_id = {{org_id}}
  AND payment_date >= {{start_date}}
  AND payment_date <= {{end_date}}
  AND status = 'paid'
GROUP BY week
ORDER BY week;
```

**8-Week Rolling Average (Wages):**
```sql
SELECT
  transaction_date,
  AVG(amount) OVER (
    ORDER BY transaction_date
    ROWS BETWEEN 56 PRECEDING AND CURRENT ROW
  ) AS rolling_avg_wages
FROM transactions
WHERE
  organization_id = {{org_id}}
  AND account_code IN (SELECT account_code FROM accounts WHERE account_type = 'wages')
GROUP BY transaction_date
ORDER BY transaction_date;
```

### Performance Optimization

- Index on `(organization_id, payment_date)` already exists
- Use Metabase query caching (15-minute TTL)
- Limit initial date range to 6 months
- [Source: database-schema.md#performance-indexes]

### Testing

**Test Execution:**
1. Load dashboard with test data
2. Verify all charts render
3. Test date filter functionality
4. Measure load time (<3 seconds)
5. Test export/import from JSON

**Test Documentation:**
- `docs/qa/1.7-dashboard-tests.md`

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-22 | 1.0 | Initial story creation from Epic 1 | Bob (Scrum Master) |

## Dev Agent Record

_This section will be populated by the development agent during implementation._

## QA Results

_This section will be populated by the QA Agent after implementation._
