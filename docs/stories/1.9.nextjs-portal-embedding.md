# Story 1.9: Embed Metabase Dashboards in Next.js Portal

## Status
**Draft**

## Story
**As a** dashboard user,
**I want** Metabase dashboards embedded in the Next.js portal with role-based access,
**So that** I can view my authorized financial dashboards in a unified interface.

**Note:** Next.js project foundation and authentication are already implemented in Stories 1.0 and 1.8. This story focuses on dashboard embedding, layout, and role-based routing.

## Acceptance Criteria

1. Dashboard layout components created: Header with user menu, Sidebar with dashboard navigation, Main content area
2. Protected dashboard route created: `/dashboards/income-expenses` (requires authentication from Story 1.0)
3. Metabase embed URL generation implemented: JWT-signed URLs with user context (organization_id, role)
4. Income vs Expenses dashboard embedded via secure iframe with proper CORS and CSP headers
5. Role-based dashboard routing: Users automatically redirected to authorized dashboards based on role
6. Dashboard access logging: Every dashboard view logged to `dashboard_access` table with user_id, timestamp
7. Error handling: Dashboard load failures show user-friendly error message, retry option
8. Responsive dashboard layout: Works on desktop (1920px) and tablet (1024px), iframe resizes properly
9. "Last updated" timestamp displayed on dashboard (sourced from `organizations.last_sync_at`)
10. User menu in header: Display user email, role badge, logout button
11. 5 internal team members successfully log in and view embedded dashboard during Week 2 demo

## Tasks / Subtasks

- [ ] **Task 1: Create Dashboard Layout Components** (AC: 1, 8, 10)
  - [ ] Create `components/layout/Header.tsx` with user menu
  - [ ] Create `components/layout/Sidebar.tsx` with dashboard navigation
  - [ ] Create `components/layout/DashboardLayout.tsx` wrapper component
  - [ ] Add user email and role badge display in header
  - [ ] Add logout button to header user menu
  - [ ] Make layout responsive (desktop and tablet)

- [ ] **Task 2: Create Metabase Embed URL Generator** (AC: 3)
  - [ ] Create `lib/metabase/generateEmbedUrl.ts` utility
  - [ ] Implement JWT signing with Metabase secret key
  - [ ] Add user context to JWT payload (organization_id, role)
  - [ ] Set JWT expiry to 1 hour
  - [ ] Add Metabase site URL configuration from env vars
  - [ ] Document embed URL format

- [ ] **Task 3: Build MetabaseEmbed Component** (AC: 4, 7, 8)
  - [ ] Create `components/dashboard/MetabaseEmbed.tsx`
  - [ ] Implement secure iframe with sandbox attributes
  - [ ] Add iframe loading state and spinner
  - [ ] Handle iframe load errors with retry option
  - [ ] Make iframe responsive (height/width adjust to container)
  - [ ] Add "Last updated" timestamp display

- [ ] **Task 4: Create Income vs Expenses Dashboard Page** (AC: 2, 4, 9)
  - [ ] Create `/app/(portal)/dashboards/income-expenses/page.tsx`
  - [ ] Fetch user session (from Story 1.0 auth)
  - [ ] Generate Metabase embed URL with user context
  - [ ] Render MetabaseEmbed component with signed URL
  - [ ] Fetch and display last_sync_at timestamp from organizations table
  - [ ] Test protected route (redirect to login if unauthenticated)

- [ ] **Task 5: Implement Role-Based Dashboard Routing** (AC: 5)
  - [ ] Create `/app/(portal)/dashboards/page.tsx` (dashboard home)
  - [ ] Fetch user role from session
  - [ ] Create role-to-dashboard mapping logic
  - [ ] Redirect users to their default dashboard based on role
  - [ ] Executive â†’ income-expenses, Manager â†’ income-expenses, Staff â†’ (future)
  - [ ] Handle edge cases (no dashboards for role)

- [ ] **Task 6: Implement Dashboard Access Logging** (AC: 6)
  - [ ] Create API route: `/app/api/dashboard-access/route.ts`
  - [ ] Log dashboard view to `dashboard_access` table
  - [ ] Record: user_id, dashboard_id, accessed_at timestamp
  - [ ] Call logging API when dashboard loads
  - [ ] Handle logging failures gracefully (don't block dashboard)

- [ ] **Task 7: Configure CSP Headers for iframe** (AC: 4)
  - [ ] Update `next.config.js` with Content Security Policy headers
  - [ ] Whitelist Metabase domain for frame-src
  - [ ] Configure frame-ancestors for security
  - [ ] Test iframe loads with CSP enabled

- [ ] **Task 8: Create Error Handling UI** (AC: 7)
  - [ ] Create `components/dashboard/DashboardError.tsx` component
  - [ ] Display user-friendly error message
  - [ ] Add retry button for failed dashboard loads
  - [ ] Log errors to console for debugging
  - [ ] Test error handling with invalid Metabase URL

- [ ] **Task 9: User Acceptance Testing** (AC: 11)
  - [ ] Invite 5 team members (different roles)
  - [ ] Test login and dashboard access for each user
  - [ ] Verify role-based routing works correctly
  - [ ] Verify embedded dashboard displays data
  - [ ] Collect feedback on UX and performance
  - [ ] Fix critical issues identified during UAT

## Dev Notes

### Story Scope Clarification

**What Stories 1.0 and 1.8 Already Provide:**
- âœ… Next.js 15 project initialized with App Router, Chakra UI 2.8+
- âœ… Supabase Auth frontend integration (login, signup, logout pages)
- âœ… Authentication middleware for protected routes
- âœ… Supabase Auth backend configuration with RLS policies
- âœ… XeroPulse branding applied (Chakra UI custom theme with brand colors)
- âœ… Vercel deployment configured
- [Source: Stories 1.0, 1.8]

**What This Story (1.9) Adds:**
- ðŸ”§ Dashboard layout components (header, sidebar, main content)
- ðŸ”§ Metabase iframe embedding with JWT-signed URLs
- ðŸ”§ Role-based dashboard routing
- ðŸ”§ Dashboard access logging
- ðŸ”§ User menu with role display
- ðŸ”§ Last updated timestamp display
- ðŸ”§ Error handling for dashboard loading
- [Source: frontend-architecture.md, deployment-architecture.md]

### Tech Stack

**Frontend (from Story 1.0):**
- Next.js 15+ (App Router) âœ…
- TypeScript 5.0+ âœ…
- Chakra UI 2.8+ (95% UI coverage) âœ…
- AG-UI Enterprise (4 complex tables) âœ…
- Chakra UI Motion (Framer Motion) âœ…
- [Source: tech-stack.md]

**Authentication (from Stories 1.0 + 1.8):**
- Supabase Auth (email/password) âœ…
- JWT session management âœ…
- Row Level Security policies âœ…
- [Source: tech-stack.md#authentication]

**This Story Adds:**
- Metabase iframe embedding
- JWT signing for dashboard URLs
- Dashboard access logging
- Role-based routing logic

### Metabase Embedding

**Signed Embed URL Generation:**
```typescript
import jwt from 'jsonwebtoken';

export function generateMetabaseEmbedUrl(
  dashboardId: number,
  user: { organization_id: string; role: string }
): string {
  const payload = {
    resource: { dashboard: dashboardId },
    params: {
      organization_id: user.organization_id,
      user_role: user.role
    },
    exp: Math.round(Date.now() / 1000) + (60 * 60) // 1 hour
  };

  const token = jwt.sign(payload, process.env.METABASE_SECRET_KEY!);
  return `${process.env.METABASE_SITE_URL}/embed/dashboard/${token}#bordered=true&titled=true`;
}
```
[Source: deployment-architecture.md#dashboard-embedding-security]

### Project Structure

**From Story 1.0 (Already Exists):**
```
app/
â”œâ”€â”€ (auth)/
â”‚   â”œâ”€â”€ login/page.tsx         âœ… Story 1.0
â”‚   â”œâ”€â”€ signup/page.tsx        âœ… Story 1.0
â”‚   â””â”€â”€ reset-password/        âœ… Story 1.0
â”œâ”€â”€ layout.tsx                 âœ… Story 1.0
â””â”€â”€ page.tsx                   âœ… Story 1.0

components/
â”œâ”€â”€ chakra/                    âœ… Story 1.0 (Chakra UI theme)
â”œâ”€â”€ ui/                        âœ… Story 1.0 (Custom Chakra components)
â”œâ”€â”€ ag-grid/                   âœ… Story 1.0 (AG-UI Enterprise - 4 tables)
â””â”€â”€ auth/                      âœ… Story 1.0

lib/
â”œâ”€â”€ supabase/                  âœ… Story 1.0
â”‚   â”œâ”€â”€ client.ts
â”‚   â””â”€â”€ middleware.ts
â””â”€â”€ utils/                     âœ… Story 1.0

middleware.ts                  âœ… Story 1.0
```

**This Story (1.9) Adds:**
```
app/
â”œâ”€â”€ (portal)/                  ðŸ†• This story
â”‚   â”œâ”€â”€ dashboards/
â”‚   â”‚   â”œâ”€â”€ page.tsx          ðŸ†• Dashboard home (role-based redirect)
â”‚   â”‚   â””â”€â”€ income-expenses/
â”‚   â”‚       â””â”€â”€ page.tsx      ðŸ†• Income vs Expenses embedded dashboard
â”‚   â””â”€â”€ layout.tsx            ðŸ†• Dashboard layout wrapper
â””â”€â”€ api/
    â””â”€â”€ dashboard-access/
        â””â”€â”€ route.ts          ðŸ†• Access logging API

components/
â”œâ”€â”€ layout/                   ðŸ†• This story
â”‚   â”œâ”€â”€ Header.tsx           ðŸ†• Header with user menu
â”‚   â”œâ”€â”€ Sidebar.tsx          ðŸ†• Dashboard navigation
â”‚   â””â”€â”€ DashboardLayout.tsx  ðŸ†• Layout wrapper
â””â”€â”€ dashboard/                ðŸ†• This story
    â”œâ”€â”€ MetabaseEmbed.tsx    ðŸ†• Iframe component
    â””â”€â”€ DashboardError.tsx   ðŸ†• Error UI

lib/
â””â”€â”€ metabase/                 ðŸ†• This story
    â””â”€â”€ generateEmbedUrl.ts  ðŸ†• JWT signing utility
```
[Source: frontend-architecture.md]

### Environment Variables

**Already Configured (Story 1.0):**
```env
NEXT_PUBLIC_SUPABASE_URL=https://[project-ref].supabase.co   âœ… Story 1.0
NEXT_PUBLIC_SUPABASE_ANON_KEY=[anon-key]                    âœ… Story 1.0
SUPABASE_SERVICE_ROLE_KEY=[service-role-key]                âœ… Story 1.0
NEXT_PUBLIC_APP_URL=https://xeropulse.vercel.app            âœ… Story 1.0
```

**This Story Adds:**
```env
METABASE_SITE_URL=https://metabase.xeropulse.com           ðŸ†• From Story 1.6
METABASE_SECRET_KEY=[embedding-secret-from-story-1.6]      ðŸ†• This story uses
```

**Note:** Metabase credentials come from Story 1.6 deployment.

### Dashboard Access Logging Schema

**Database Table (from Story 1.3):**
```sql
CREATE TABLE dashboard_access (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES users(id),
  dashboard_id VARCHAR(50) NOT NULL,
  accessed_at TIMESTAMP WITH TIME ZONE DEFAULT now(),
  organization_id UUID NOT NULL REFERENCES organizations(id)
);

CREATE INDEX idx_dashboard_access_user ON dashboard_access(user_id, accessed_at DESC);
```
[Source: database-schema.md]

### Content Security Policy (CSP) Headers

**Next.js Configuration:**
```typescript
// next.config.js
const nextConfig = {
  async headers() {
    return [
      {
        source: '/(.*)',
        headers: [
          {
            key: 'Content-Security-Policy',
            value: [
              "default-src 'self'",
              "frame-src 'self' https://metabase.xeropulse.com",
              "script-src 'self' 'unsafe-eval' 'unsafe-inline'",
              "style-src 'self' 'unsafe-inline'",
            ].join('; ')
          }
        ]
      }
    ];
  }
};
```
[Source: security-architecture.md#application-security-headers]

### Dependencies

**Depends On:**
- Story 1.0: Next.js project with auth UI (foundation)
- Story 1.3: Supabase database with `dashboard_access` table
- Story 1.6: Metabase deployed with embedding enabled
- Story 1.7: Income vs Expenses dashboard created in Metabase
- Story 1.8: Supabase Auth backend with RLS policies

**Enables:**
- Epic 2: Additional dashboard embedding
- Future user management features
- Future dashboard customization

### Role-Based Dashboard Mapping

**Default Dashboards by Role:**
```typescript
const ROLE_DASHBOARD_MAP = {
  executive: '/dashboards/income-expenses',
  manager: '/dashboards/income-expenses',
  staff: '/dashboards/income-expenses',  // Limited by RLS
  admin: '/dashboards/income-expenses'
};
```

**Future Enhancement (Epic 2+):**
- Multiple dashboards per role
- User-customizable dashboard preferences
- Dashboard permissions from database
- [Source: requirements.md#functional-requirements FR2, FR7]

### Testing

**Testing Standards:**

Functional testing of dashboard embedding, layout, and role-based access.

**Testing Approach:**
- Dashboard layout and responsiveness testing
- Metabase iframe embedding verification
- Role-based routing validation
- Access logging verification
- Error handling testing
- User acceptance testing

**Test Execution:**

1. **Dashboard Layout Test (AC: 1, 8, 10):**
   - Access `/dashboards/income-expenses` while logged in
   - Verify Header displays with user email and role badge
   - Verify Sidebar displays with dashboard navigation
   - Verify layout is responsive (test at 1920px and 1024px)
   - Verify user menu in header works (dropdown, logout button)

2. **Metabase Embed URL Generation Test (AC: 3):**
   - Generate embed URL using utility function
   - Decode JWT token to verify payload
   - Check payload contains: organization_id, user_role
   - Verify JWT expiry is 1 hour from issue time
   - Test URL format matches expected Metabase pattern

3. **Dashboard Embedding Test (AC: 4, 9):**
   - Load dashboard page
   - Verify iframe renders with correct src URL
   - Verify iframe displays Metabase dashboard content
   - Check for CORS errors in browser console (should be none)
   - Verify "Last updated" timestamp displays correctly
   - Verify timestamp matches `organizations.last_sync_at`

4. **Role-Based Routing Test (AC: 5):**
   - Log in as executive user â†’ verify redirect to income-expenses
   - Log in as manager user â†’ verify redirect to income-expenses
   - Log in as staff user â†’ verify redirect to income-expenses
   - (Future) Log in as user with no dashboard access â†’ verify error page

5. **Access Logging Test (AC: 6):**
   - Access dashboard while logged in
   - Query `dashboard_access` table
   - Verify new record inserted with:
     - Correct user_id
     - Correct dashboard_id
     - Current timestamp
     - Correct organization_id
   - Access dashboard 5 times, verify 5 log entries

6. **Error Handling Test (AC: 7):**
   - Test with invalid Metabase URL (simulate Metabase down)
   - Verify user-friendly error message displays
   - Verify retry button appears and works
   - Test with invalid JWT secret (should fail gracefully)
   - Check error logged to console for debugging

7. **Responsive Design Test (AC: 8):**
   - Test at 1920px (desktop): Full layout with sidebar
   - Test at 1024px (tablet): Sidebar collapses or adjusts
   - Verify iframe resizes proportionally
   - Test scrolling behavior
   - Verify no horizontal scroll

8. **CSP Headers Test (AC: 4):**
   - Load dashboard page
   - Check browser console for CSP violations (should be none)
   - Verify frame-src allows Metabase domain
   - Test that other domains are blocked

9. **User Acceptance Test (AC: 11):**
   - Invite 5 team members with different roles
   - Have each user:
     - Log in to portal
     - Navigate to dashboard
     - Verify data displays correctly
     - Test responsiveness on their devices
   - Collect feedback on:
     - Ease of use
     - Dashboard load time (<3 seconds target)
     - UI/UX issues
   - Document feedback and create follow-up issues if needed

10. **Integration Test (All AC):**
    - End-to-end flow:
      1. User logs in (Story 1.0 auth)
      2. Gets redirected based on role
      3. Dashboard generates embed URL
      4. Access logged to database
      5. Metabase iframe loads successfully
      6. User can navigate, logout works
    - Verify entire flow completes without errors

**Test Documentation:**
- Document all test results in `docs/qa/1.9-dashboard-embedding-tests.md`
- Include screenshots of dashboard layout
- Record JWT token structure
- Capture access logging database queries
- Document UAT feedback
- Record load times for dashboards

**Testing Tools:**
- Browser DevTools (Network, Console, Elements)
- JWT decoder (jwt.io)
- Database SQL queries (Supabase SQL Editor)
- Responsive design testing (browser dev tools, BrowserStack)
- Performance monitoring (Lighthouse, Vercel Analytics)

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-22 | 1.0 | Initial story creation from Epic 1 | Bob (Scrum Master) |
| 2025-10-22 | 1.1 | Updated to focus on dashboard embedding, removed duplication with Story 1.0 | Sarah (Product Owner) |

## Dev Agent Record

_This section will be populated by the development agent during implementation._

## QA Results

_This section will be populated by the QA Agent after implementation._
