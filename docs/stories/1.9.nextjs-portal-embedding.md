# Story 1.9: Build Minimal Next.js Portal with Dashboard Embedding

## Status
**Draft**

## Story
**As a** dashboard user,
**I want** a web portal where I can log in and view the Income vs Expenses dashboard,
**So that** I can access financial insights without navigating multiple tools.

## Acceptance Criteria

1. Next.js 15 project initialized with App Router, Tailwind CSS, shadcn/ui components
2. Login page implemented: Email/password form integrated with Supabase Auth client
3. Protected dashboard route (`/dashboards/income-expenses`) requiring authentication (middleware checks session)
4. Income vs Expenses dashboard embedded via iframe from Metabase URL
5. Authentication token passed from Next.js to Metabase (seamless single sign-on, no double login)
6. Logout functionality implemented (clears session, redirects to login page)
7. Basic branding applied: XeroPulse logo, blue/gray color scheme, clean typography
8. Responsive layout for desktop (1920px) and tablet (1024px) screen sizes
9. Error handling: 401 redirect to login, 404 page for invalid routes, dashboard load failures show error message
10. Deployed to Vercel (production URL accessible, HTTPS enabled)
11. 5 internal team members successfully log in and view dashboard during Week 2 demo

## Tasks / Subtasks

- [ ] **Task 1: Initialize Next.js Project** (AC: 1)
  - [ ] Run `npx create-next-app@latest xeropulse-portal --typescript --app --tailwind`
  - [ ] Install shadcn/ui: `npx shadcn-ui@latest init`
  - [ ] Install Supabase client: `npm install @supabase/supabase-js`
  - [ ] Configure Tailwind with custom theme colors
  - [ ] Set up project structure

- [ ] **Task 2: Configure Supabase Client** (AC: 2, 5)
  - [ ] Create `.env.local` with Supabase credentials
  - [ ] Create Supabase client utility
  - [ ] Configure auth helpers for server/client components

- [ ] **Task 3: Build Login Page** (AC: 2, 9)
  - [ ] Create `/app/login/page.tsx`
  - [ ] Build login form with shadcn/ui Input and Button
  - [ ] Integrate Supabase Auth login
  - [ ] Add error handling (invalid credentials)
  - [ ] Redirect to dashboard on success

- [ ] **Task 4: Implement Authentication Middleware** (AC: 3, 9)
  - [ ] Create middleware to protect dashboard routes
  - [ ] Check Supabase session
  - [ ] Redirect to login if unauthenticated
  - [ ] Handle 401 errors

- [ ] **Task 5: Build Dashboard Embedding** (AC: 4, 5)
  - [ ] Create `/app/dashboards/income-expenses/page.tsx`
  - [ ] Generate signed Metabase embed URL with JWT
  - [ ] Embed dashboard via iframe
  - [ ] Pass user context (organization_id, role) in JWT
  - [ ] Handle iframe load errors

- [ ] **Task 6: Implement Logout** (AC: 6)
  - [ ] Create logout function
  - [ ] Clear Supabase session
  - [ ] Redirect to login page

- [ ] **Task 7: Apply Branding and Styling** (AC: 7, 8)
  - [ ] Add XeroPulse logo
  - [ ] Configure blue/gray color scheme in Tailwind
  - [ ] Create responsive layout
  - [ ] Test on desktop (1920px) and tablet (1024px)

- [ ] **Task 8: Deploy to Vercel** (AC: 10)
  - [ ] Push code to GitHub
  - [ ] Connect Vercel to repository
  - [ ] Configure environment variables
  - [ ] Deploy production build
  - [ ] Verify HTTPS access

- [ ] **Task 9: User Acceptance Testing** (AC: 11)
  - [ ] Invite 5 team members
  - [ ] Test login with each user
  - [ ] Verify dashboard loads correctly
  - [ ] Collect feedback
  - [ ] Fix critical issues

## Dev Notes

### Tech Stack

**Frontend:**
- Next.js 15+ (App Router)
- TypeScript 5.0+
- Tailwind CSS 3.4+
- shadcn/ui v4 (base components)
- [Source: tech-stack.md]

**Authentication:**
- Supabase Auth (email/password)
- JWT session management
- [Source: tech-stack.md#authentication]

### Metabase Embedding

**Signed Embed URL Generation:**
```typescript
import jwt from 'jsonwebtoken';

export function generateMetabaseEmbedUrl(
  dashboardId: number,
  user: { organization_id: string; role: string }
): string {
  const payload = {
    resource: { dashboard: dashboardId },
    params: {
      organization_id: user.organization_id,
      user_role: user.role
    },
    exp: Math.round(Date.now() / 1000) + (60 * 60) // 1 hour
  };

  const token = jwt.sign(payload, process.env.METABASE_SECRET_KEY!);
  return `${process.env.METABASE_SITE_URL}/embed/dashboard/${token}#bordered=true&titled=true`;
}
```
[Source: deployment-architecture.md#dashboard-embedding-security]

### Project Structure

```
xeropulse-portal/
├── app/
│   ├── login/
│   │   └── page.tsx
│   ├── dashboards/
│   │   └── income-expenses/
│   │       └── page.tsx
│   ├── layout.tsx
│   └── page.tsx
├── components/
│   ├── ui/ (shadcn/ui)
│   ├── auth/
│   │   └── LoginForm.tsx
│   └── dashboard/
│       └── MetabaseEmbed.tsx
├── lib/
│   ├── supabase.ts
│   └── metabase.ts
└── middleware.ts
```

### Environment Variables

```env
NEXT_PUBLIC_SUPABASE_URL=https://[project-ref].supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=[anon-key]
METABASE_SITE_URL=https://metabase.xeropulse.com
METABASE_SECRET_KEY=[embedding-secret]
```

### Testing

**Test Execution:**
1. Test login flow (valid/invalid credentials)
2. Test dashboard embedding and iframe load
3. Test logout flow
4. Test responsive design (1920px, 1024px)
5. Test deployment on Vercel
6. UAT with 5 team members

**Test Documentation:**
- `docs/qa/1.9-portal-tests.md`

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-22 | 1.0 | Initial story creation from Epic 1 | Bob (Scrum Master) |

## Dev Agent Record

_This section will be populated by the development agent during implementation._

## QA Results

_This section will be populated by the QA Agent after implementation._
