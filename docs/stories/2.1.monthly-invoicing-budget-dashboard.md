# Story 2.1: Build Monthly Invoicing to Budget Dashboard (Dashboard 2)

## Status
**Draft**

## Story
**As a** finance manager,
**I want** a dashboard comparing actual invoicing performance against budget targets by month,
**So that** I can track revenue goals and identify budget variances quickly.

## Acceptance Criteria

1. Metabase dashboard created with title "Monthly Invoicing to Budget"
2. Chart 1: Bar chart showing actual invoiced amounts by month (source: Xero Payments API, aggregated by invoice date)
3. Chart 2: Line chart overlay showing budget targets by month (source: Xero Budget Summary API)
4. Chart 3: Variance calculation displayed (Actual - Budget) with color coding (green for over budget, red for under budget)
5. Chart 4: Year-to-date totals KPI cards (YTD Actual, YTD Budget, YTD Variance %)
6. Chart 5: Payments received overlay (source: Xero Payments API, distinguishing invoiced vs. collected amounts)
7. Date range filter widget (default: current fiscal year, user-adjustable)
8. Budget category filter (if multiple budgets exist in Xero)
9. Dashboard loads in <3 seconds with 12 months of data
10. Visual design: Consistent with Dashboard 1 styling (blue/gray palette, clean layout)
11. "Last updated" timestamp displayed
12. Dashboard exported to version control (`/apps/metabase-config/dashboards/dashboard-2-budget.json`)

## Tasks / Subtasks

- [ ] **Task 1: Create Metabase Dashboard Shell** (AC: 1, 10)
  - [ ] Log into Metabase instance at configured URL
  - [ ] Create new dashboard titled "Monthly Invoicing to Budget"
  - [ ] Set dashboard slug to `monthly-invoicing-budget`
  - [ ] Apply consistent styling (blue/gray palette matching Dashboard 1)
  - [ ] Configure dashboard metadata (description, tags)

- [ ] **Task 2: Create SQL Queries for Monthly Actuals** (AC: 2, 6)
  - [ ] Write Metabase SQL query for monthly actual revenue
  - [ ] Query `financial_data` table filtering by `transaction_type = 'revenue'`
  - [ ] Group by month using `DATE_TRUNC('month', transaction_date)`
  - [ ] Add organization_id parameter: `{{organization_id}}`
  - [ ] Add fiscal year date filter: `transaction_date >= '2024-07-01' AND transaction_date < '2025-07-01'`
  - [ ] Test query returns 12 months of data
  - [ ] Validate performance (<1 second execution time)

- [ ] **Task 3: Create SQL Query for Monthly Budgets** (AC: 3)
  - [ ] Write Metabase SQL query for monthly budget targets
  - [ ] Query `budgets` table filtering by `account_type = 'revenue'`
  - [ ] Group by month using `DATE_TRUNC('month', budget_month)`
  - [ ] Add organization_id and fiscal year filters
  - [ ] Join with actuals using FULL OUTER JOIN on month
  - [ ] Test query returns budget data correctly

- [ ] **Task 4: Create Variance Calculation Query** (AC: 4)
  - [ ] Combine actuals and budgets in single CTE-based query
  - [ ] Calculate variance_pct: `((actual - budget) / budget * 100)`
  - [ ] Handle division by zero (CASE WHEN budget > 0)
  - [ ] Add color coding logic for positive/negative variance
  - [ ] Test calculation accuracy with sample data

- [ ] **Task 5: Create Grouped Bar Chart Visualization** (AC: 2, 3, 4)
  - [ ] Create Metabase grouped bar chart
  - [ ] X-Axis: `month_label` (Mon YYYY format)
  - [ ] Y-Axis Series 1: `actual` (Orange #FB923C)
  - [ ] Y-Axis Series 2: `budget` (Blue #3B82F6)
  - [ ] Configure axis labels and formatting ($K notation)
  - [ ] Add legend (Orange: Actual, Blue: Budget)
  - [ ] Test chart renders correctly with 12 months data

- [ ] **Task 6: Create YTD KPI Cards** (AC: 5)
  - [ ] Create SQL query for YTD Actual (SUM from fiscal year start)
  - [ ] Create SQL query for YTD Budget (SUM from fiscal year start)
  - [ ] Calculate YTD Variance %: `((YTD_Actual - YTD_Budget) / YTD_Budget * 100)`
  - [ ] Create 3 Metabase "Number" visualizations (KPI cards)
  - [ ] Format as currency (AUD) with appropriate precision
  - [ ] Position cards prominently at top of dashboard

- [ ] **Task 7: Add Date Range Filter Widget** (AC: 7)
  - [ ] Create Metabase date parameter for fiscal year selection
  - [ ] Set default value to current fiscal year (FY25: 2024-07-01 to 2025-06-30)
  - [ ] Add parameter to all queries (actuals, budgets, KPIs)
  - [ ] Test filter updates all charts dynamically
  - [ ] Configure user-friendly date picker interface

- [ ] **Task 8: Add Budget Category Filter** (AC: 8)
  - [ ] Create Metabase parameter for budget category
  - [ ] Query distinct budget categories from `budgets` table
  - [ ] Add optional filter to queries (WHERE budget_category = {{category}})
  - [ ] Test filter works when multiple budgets exist
  - [ ] Handle case when no budget categories exist (hide filter)

- [ ] **Task 9: Add Last Updated Timestamp** (AC: 11)
  - [ ] Query `organizations.last_sync_at` for data freshness
  - [ ] Create Metabase text visualization displaying timestamp
  - [ ] Format as: "Last updated: YYYY-MM-DD HH:MM"
  - [ ] Position timestamp in dashboard footer or header
  - [ ] Verify timestamp updates after ETL sync

- [ ] **Task 10: Performance Optimization** (AC: 9)
  - [ ] Test dashboard load time with 12 months of data
  - [ ] Measure query execution times (all queries < 1 second)
  - [ ] Verify dashboard loads in < 3 seconds total
  - [ ] Enable Metabase query caching (15-minute TTL)
  - [ ] Optimize slow queries if needed (add indexes, refactor CTEs)

- [ ] **Task 11: Export Dashboard Configuration** (AC: 12)
  - [ ] Export dashboard JSON from Metabase admin interface
  - [ ] Save to `/apps/metabase-config/dashboards/dashboard-2-budget.json`
  - [ ] Commit to version control with descriptive message
  - [ ] Document export/import procedure for future reference
  - [ ] Test import in staging environment

- [ ] **Task 12: User Acceptance Testing**
  - [ ] Load dashboard with real Xero data
  - [ ] Verify all 12 months display correctly
  - [ ] Test variance calculations match manual calculations
  - [ ] Test filters (date range, budget category) work correctly
  - [ ] Verify visual design matches Dashboard 1 styling
  - [ ] Get stakeholder sign-off on dashboard

## Dev Notes

### Architecture Context

**BI Platform:**
- **Platform:** Metabase (open-source business intelligence)
- **Version:** Latest
- **Purpose:** Embedded dashboard creation with PostgreSQL integration
- **Deployment:** VPS instance (configured in Story 1.6)
- **Access:** https://metabase.[domain]
- [Source: tech-stack.md#bi-platform]

**Key Capabilities:**
- SQL-based dashboard queries against Supabase PostgreSQL
- Grouped bar charts, line charts, KPI cards, date filters
- Dashboard embedding capabilities (used in Story 1.9)
- Query result caching (15-minute TTL)
- [Source: tech-stack.md]

### Data Requirements

**Primary Tables:**

1. **financial_data** - Unified financial transactions from Xero
```sql
-- Relevant fields for Dashboard 2
SELECT
    organization_id,           -- Multi-tenant scoping
    transaction_type,          -- Filter for 'revenue'
    amount,                    -- Invoice/payment amounts
    transaction_date,          -- Group by month
    account_code,              -- Account categorization
    status,                    -- Transaction status
    source                     -- Data source ('xero')
FROM financial_data
```
[Source: database-schema.md#financial-data-tables]

2. **budgets** - Budget tracking from Xero
```sql
-- Budget table structure
SELECT
    organization_id,
    account_id,                -- Links to accounts table
    period_start,              -- Budget period start date
    period_end,                -- Budget period end date
    budget_amount,             -- Target budget amount
    actual_amount              -- Actual spending (optional)
FROM budgets
```
[Source: database-schema.md#financial-data-tables]

**Important:** The `budgets` table must be populated by the n8n ETL workflow (Story 1.5) before this dashboard can function. If no budget data exists, the dashboard should display a message: "No budget data available. Please configure budgets in Xero."

### API Specifications

**Xero API Endpoints (for ETL reference):**

1. **Payments API** (Actual Revenue Data)
```
GET https://api.xero.com/api.xro/2.0/Payments
```
- **Parameters:** `where=PaymentType=="ACCRECPAYMENT" AND Status=="AUTHORISED"`
- **Fields Used:** `Date`, `Amount`, `PaymentType`
- **Frequency:** Every 2 hours (configured in n8n)
- [Source: xero-api-endpoint-mapping.md#dashboard-2-monthly-invoicing-to-budget]

2. **Budget Summary API** (Budget Targets)
```
GET https://api.xero.com/api.xro/2.0/Reports/BudgetSummary
```
- **Parameters:** `periods=12` (for 12-month view)
- **Fields Used:** Budget line items with monthly amounts
- **Frequency:** Daily (budgets change infrequently)
- [Source: xero-api-endpoint-mapping.md#dashboard-2-monthly-invoicing-to-budget]

**Note:** This story focuses on Metabase dashboard creation. API integration was completed in Story 1.4-1.5.

### Metabase Dashboard Configuration

**Dashboard Slug:** `monthly-invoicing-budget`

**Main Query (Grouped Bar Chart):**
```sql
WITH monthly_actuals AS (
  SELECT
    DATE_TRUNC('month', transaction_date) AS month,
    SUM(amount) AS actual
  FROM financial_data
  WHERE
    organization_id = {{organization_id}}
    AND transaction_type = 'revenue'
    AND transaction_date >= '2024-07-01'
    AND transaction_date < '2025-07-01'
  GROUP BY month
),
monthly_budgets AS (
  SELECT
    DATE_TRUNC('month', budget_month) AS month,
    SUM(amount) AS budget
  FROM budgets
  WHERE organization_id = {{organization_id}}
    AND account_type = 'revenue'
    AND budget_year = 'FY25'
  GROUP BY month
)
SELECT
  TO_CHAR(a.month, 'Mon YYYY') AS month_label,
  COALESCE(a.actual, 0) AS actual,
  COALESCE(b.budget, 0) AS budget,
  CASE
    WHEN b.budget > 0 THEN ((a.actual - b.budget) / b.budget * 100)
    ELSE 0
  END AS variance_pct
FROM monthly_actuals a
FULL OUTER JOIN monthly_budgets b ON a.month = b.month
ORDER BY a.month
```
[Source: dashboard-specifications.md#dashboard-2-monthly-invoicing-to-budget]

**Chart Configuration:**
- **Chart Type:** Grouped Bar Chart
- **X-Axis:** `month_label` (Mon YYYY format)
- **Y-Axis Multi-Series:**
  - `actual` → Color: Orange (#FB923C)
  - `budget` → Color: Blue (#3B82F6)
- **Legend:** "Actual" (Orange), "Budget" (Blue)
- **Y-Axis Format:** Currency (AUD) with $K notation
- [Source: dashboard-specifications.md#metabase-chart-configuration]

**YTD KPI Cards Queries:**

1. **YTD Actual:**
```sql
SELECT SUM(amount) AS ytd_actual
FROM financial_data
WHERE organization_id = {{organization_id}}
  AND transaction_type = 'revenue'
  AND transaction_date >= '2024-07-01'
  AND transaction_date <= CURRENT_DATE
```

2. **YTD Budget:**
```sql
SELECT SUM(budget_amount) AS ytd_budget
FROM budgets
WHERE organization_id = {{organization_id}}
  AND account_type = 'revenue'
  AND period_start >= '2024-07-01'
  AND period_end <= CURRENT_DATE
```

3. **YTD Variance %:**
```sql
SELECT
  ((ytd_actual - ytd_budget) / ytd_budget * 100) AS ytd_variance_pct
FROM (
  SELECT
    (SELECT SUM(amount) FROM financial_data WHERE ...) AS ytd_actual,
    (SELECT SUM(budget_amount) FROM budgets WHERE ...) AS ytd_budget
) AS ytd_data
```

### Visual Design Specifications

**Color Palette (Consistent with Dashboard 1):**
- **Actual Revenue:** Orange (#FB923C)
- **Budget Targets:** Blue (#3B82F6)
- **Positive Variance:** Green (#10B981)
- **Negative Variance:** Red (#EF4444)
- **Background:** Off-white (#F8FAFC)
- **Text:** Dark gray (#1E293B)
- [Source: dashboard-specifications.md#visual-components]

**Layout Structure:**
```
+-----------------------------------------------------------+
| Dashboard Title: Monthly Invoicing to Budget             |
| Filters: [Fiscal Year ▼] [Budget Category ▼]            |
+-----------------------------------------------------------+
| YTD Actual      | YTD Budget      | YTD Variance %      |
| $XXX,XXX        | $XXX,XXX        | +X.X%               |
+-----------------------------------------------------------+
|                                                           |
|           Grouped Bar Chart (Actual vs Budget)           |
|           [Orange bars + Blue bars by month]             |
|                                                           |
+-----------------------------------------------------------+
| Last updated: 2025-10-24 14:30                           |
+-----------------------------------------------------------+
```

### Performance Optimization

**Query Performance:**
- **Target:** All queries < 1 second execution time
- **Optimization:** Leverage existing indexes on `financial_data`:
  - `idx_financial_org_date (organization_id, transaction_date)`
  - `idx_financial_type_status (transaction_type, status)`
- [Source: database-schema.md#indexes-for-dashboard-queries]

**Caching:**
- **Metabase Query Cache:** Enabled with 15-minute TTL
- **Refresh Interval:** Every 2 hours (matches ETL sync frequency)
- [Source: dashboard-specifications.md#etl-requirements]

**Data Volume:**
- **12 months of revenue data:** ~1,000-5,000 transactions (estimated)
- **Budget records:** ~12 monthly budget entries
- **Total dashboard load time:** < 3 seconds (AC #9)

### File Locations

**Dashboard Export:**
```
/apps/metabase-config/dashboards/dashboard-2-budget.json
```

**Note:** This file location assumes a project structure where Metabase configurations are version-controlled. If this directory doesn't exist, create it during Task 11.

### Dependencies

**From Previous Stories:**
- **Story 1.3:** Supabase database schema (financial_data, budgets tables)
- **Story 1.5:** n8n ETL workflow populating financial_data and budgets
- **Story 1.6:** Metabase deployed and connected to Supabase

**For Future Stories:**
- **Story 2.3:** RBAC system will control which users can access this dashboard
- **Story 2.4:** Next.js portal will embed this dashboard via iframe

### Testing

**Testing Approach:**
Functional testing of Metabase dashboard creation and SQL query validation.

**Test Scenarios:**

1. **Query Validation:**
   - Execute each SQL query in Metabase SQL editor
   - Verify results match expected data format
   - Test with sample data (12 months, 5 budget entries)

2. **Chart Rendering:**
   - Verify grouped bar chart displays 12 months
   - Confirm color coding (Orange for actual, Blue for budget)
   - Test axis labels and formatting

3. **Filter Functionality:**
   - Test fiscal year filter updates all charts
   - Test budget category filter (if multiple budgets exist)
   - Verify default values load correctly

4. **Performance:**
   - Measure dashboard load time with 12 months of data
   - Verify < 3 seconds total load time
   - Test query execution times (< 1 second each)

5. **Data Accuracy:**
   - Manually calculate variance for one month
   - Compare with dashboard variance calculation
   - Verify YTD totals match manual sum

**Testing Tools:**
- Metabase SQL editor (query testing)
- Browser developer tools (load time measurement)
- PostgreSQL psql CLI (manual data verification)

**Test Data:**
- Use production Xero data synced via n8n (Story 1.5)
- Minimum 12 months of revenue transactions
- At least 12 monthly budget entries for FY25

**Success Criteria:**
- All queries execute successfully
- Dashboard loads in < 3 seconds
- Variance calculations accurate to 2 decimal places
- Visual design matches Dashboard 1 styling

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-24 | 1.0 | Initial story creation from Epic 2 | Bob (Scrum Master) |

## Dev Agent Record

_This section will be populated by the development agent during implementation._

### Agent Model Used

_To be filled by Dev Agent_

### Debug Log References

_To be filled by Dev Agent_

### Completion Notes List

_To be filled by Dev Agent_

### File List

_To be filled by Dev Agent_

## QA Results

_This section will be populated by the QA Agent after implementation._
