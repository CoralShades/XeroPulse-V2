# Story 1.6: Deploy Metabase Dashboard Engine

## Status
**Draft**

## Story
**As a** BI analyst,
**I want** Metabase deployed and connected to Supabase PostgreSQL,
**So that** I can build interactive dashboards from synchronized Xero data.

**Note:** Epic text mentions "Apache Superset" but architecture confirms **Metabase** as the BI platform.

## Acceptance Criteria

1. Metabase container running via Docker Compose with persistent volume for metadata storage
2. Metabase web UI accessible at https://metabase.[domain] with HTTPS enabled
3. Metabase connected to Supabase PostgreSQL database (connection string configured, test query successful)
4. Admin user created for Metabase with documented credentials
5. Docker resource limits configured (2GB RAM cap for Metabase container)
6. Metabase service auto-restarts on failure (Docker restart policy: unless-stopped)
7. Basic RBAC configured in Metabase (roles: Admin, Dashboard Viewer created)
8. Test chart created from Supabase data (e.g., simple bar chart of invoice totals by month)
9. Query result caching enabled (15-minute cache TTL to reduce database load)

## Tasks / Subtasks

- [ ] **Task 1: Add Metabase to Docker Compose** (AC: 1, 5, 6)
  - [ ] Update `/opt/xeropulse/docker-compose.yml`
  - [ ] Add Metabase service with official image (`metabase/metabase:latest`)
  - [ ] Configure persistent volume for Metabase metadata
  - [ ] Set memory limit to 2GB
  - [ ] Configure restart policy: `unless-stopped`
  - [ ] Expose port 3000 for Metabase UI

- [ ] **Task 2: Configure Metabase Environment Variables** (AC: 3, 9)
  - [ ] Set Metabase database (H2 embedded or PostgreSQL app DB)
  - [ ] Configure `MB_DB_TYPE`, `MB_DB_CONNECTION_URI`
  - [ ] Set embedding secret key: `MB_EMBEDDING_SECRET_KEY`
  - [ ] Enable caching: `MB_ENABLE_QUERY_CACHING=true`
  - [ ] Set cache TTL: `MB_QUERY_CACHING_TTL_RATIO=15` (15 minutes)

- [ ] **Task 3: Deploy Metabase Container** (AC: 1, 2)
  - [ ] Run `docker compose up -d metabase`
  - [ ] Configure reverse proxy for https://metabase.[domain]
  - [ ] Verify Metabase UI loads
  - [ ] Complete initial setup wizard

- [ ] **Task 4: Create Admin User and Configure RBAC** (AC: 4, 7)
  - [ ] Create admin user during setup wizard
  - [ ] Document admin credentials securely
  - [ ] Create "Admin" and "Dashboard Viewer" groups
  - [ ] Configure permissions for each group

- [ ] **Task 5: Connect Metabase to Supabase** (AC: 3)
  - [ ] Add database connection in Metabase
  - [ ] Select PostgreSQL database type
  - [ ] Enter Supabase connection details
  - [ ] Test connection with simple query
  - [ ] Sync database schema

- [ ] **Task 6: Create Test Dashboard** (AC: 8)
  - [ ] Create simple bar chart: Invoice totals by month
  - [ ] Query `financial_data` table
  - [ ] Verify chart renders correctly
  - [ ] Save as test dashboard

- [ ] **Task 7: Configure Query Caching** (AC: 9)
  - [ ] Enable query caching in Metabase settings
  - [ ] Set cache TTL to 15 minutes
  - [ ] Test cache by running same query twice
  - [ ] Verify second query uses cache

- [ ] **Task 8: Document Metabase Configuration** (AC: All)
  - [ ] Document Metabase URL and admin credentials
  - [ ] Document database connection details
  - [ ] Document RBAC groups and permissions
  - [ ] Add to `docs/infrastructure/metabase-setup.md`

## Dev Notes

### Metabase Architecture

**Deployment Model:**
- Docker container on same VPS as n8n
- Persistent metadata storage (H2 or PostgreSQL)
- [Source: deployment-architecture.md#metabase-deployment]

**Resource Allocation:**
- RAM: 2GB limit
- CPU: Shared with n8n (no explicit limit)
- Storage: <500MB for metadata
- [Source: deployment-architecture.md#metabase-instance-configuration]

### Docker Compose Configuration

```yaml
services:
  metabase:
    image: metabase/metabase:v0.47.0
    container_name: metabase-xeropulse
    restart: unless-stopped
    ports:
      - "3000:3000"
    environment:
      MB_DB_TYPE: h2
      MB_DB_FILE: /metabase-data/metabase.db
      MB_ENCRYPTION_SECRET_KEY: ${METABASE_SECRET_KEY}
      MB_EMBEDDING_SECRET_KEY: ${METABASE_EMBEDDING_KEY}
      MB_SITE_URL: https://metabase.xeropulse.com
      MB_ENABLE_QUERY_CACHING: true
      JAVA_OPTS: "-Xmx1536m -Xms512m"
    volumes:
      - metabase_data:/metabase-data
    deploy:
      resources:
        limits:
          memory: 2G
```
[Source: deployment-architecture.md#metabase-instance-configuration]

### Database Connection

**Supabase Connection String:**
```
postgresql://postgres:[password]@db.[project-ref].supabase.co:5432/postgres?sslmode=require
```

**Connection Pooling:**
- Use Supabase connection pooler for better performance
- Enable SSL mode: require
- [Source: deployment-architecture.md#supabase-infrastructure-setup]

### Embedding Configuration

**Signed Embedding (Story 1.9):**
- `MB_EMBEDDING_SECRET_KEY` used to sign dashboard URLs
- Tokens expire after 1 hour
- [Source: deployment-architecture.md#dashboard-embedding-security]

### Testing

**Test Execution:**

1. **Deployment Test (AC: 1, 2, 6):**
   - Verify container running: `docker ps | grep metabase`
   - Access https://metabase.[domain]
   - Check HTTPS certificate
   - Stop container and verify auto-restart

2. **Database Connection Test (AC: 3):**
   - Add Supabase database in Metabase
   - Run test query: `SELECT COUNT(*) FROM financial_data`
   - Verify tables sync correctly

3. **Test Dashboard (AC: 8):**
   - Create simple visualization
   - Verify data renders
   - Save dashboard

**Test Documentation:**
- `docs/qa/1.6-metabase-deployment-tests.md`

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-22 | 1.0 | Initial story creation (corrected to Metabase) | Bob (Scrum Master) |

## Dev Agent Record

_This section will be populated by the development agent during implementation._

## QA Results

_This section will be populated by the QA Agent after implementation._
