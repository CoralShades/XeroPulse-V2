# Story 1.3.2: Implement Performance Indexes for Dashboard Queries

## Status
**Draft**

## Story
**As a** database administrator,
**I want** comprehensive indexes on frequently queried fields across all xero_* tables,
**So that** dashboard queries meet the <2 second performance requirement (NFR9).

## Acceptance Criteria

1. Composite indexes created on (organization_id, date) for all date-scoped tables
2. Single-column indexes created on status, contact_id, and other frequently filtered fields
3. Covering indexes implemented for common query patterns to avoid table scans
4. Index creation verified in Supabase database editor
5. Query performance benchmarked before and after index creation
6. Migration file created and version-controlled in `supabase/migrations/`
7. Index naming follows consistent convention: `idx_{table}_{column(s)}`
8. Database size increase monitored (indexes add ~10-20% storage overhead)

## Tasks / Subtasks

- [ ] **Task 1: Create Composite Organization-Date Indexes** (AC: 1)
  - [ ] Create migration file: `supabase/migrations/YYYYMMDD_add_performance_indexes.sql`
  - [ ] Add composite indexes for dashboard date-range queries:
    ```sql
    -- Invoice queries (Dashboard 1, 2, 3, 7)
    CREATE INDEX idx_xero_invoices_org_date
    ON xero_invoices(organization_id, invoice_date DESC);

    -- Bank transactions (Dashboard 1)
    CREATE INDEX idx_xero_bank_transactions_org_date
    ON xero_bank_transactions(organization_id, date DESC);

    -- Project time entries (Dashboard 4, 6, 8)
    CREATE INDEX idx_xero_project_time_entries_org_date
    ON xero_project_time_entries(project_id, date_utc DESC);

    -- Project expenses (Dashboard 4, 8)
    CREATE INDEX idx_xero_project_expenses_org_date
    ON xero_project_expenses(project_id, date_utc DESC);
    ```
  - [ ] Verify DESC ordering for date columns (optimizes recent-first queries)

- [ ] **Task 2: Create Status Filter Indexes** (AC: 2)
  - [ ] Add status indexes for filtering queries:
    ```sql
    -- Invoice status filtering (Dashboard 2, 3, 7)
    CREATE INDEX idx_xero_invoices_status
    ON xero_invoices(status);

    -- Invoice type + status composite (for AR vs AP filtering)
    CREATE INDEX idx_xero_invoices_type_status
    ON xero_invoices(type, status);

    -- Bank transaction status
    CREATE INDEX idx_xero_bank_transactions_status
    ON xero_bank_transactions(status);

    -- Project status (Dashboard 4)
    CREATE INDEX idx_xero_projects_status
    ON xero_projects(status);
    ```

- [ ] **Task 3: Create Contact/Client Relationship Indexes** (AC: 2)
  - [ ] Add indexes for joins and lookups:
    ```sql
    -- Invoice-to-contact lookups (Dashboard 7, 8)
    CREATE INDEX idx_xero_invoices_contact_id
    ON xero_invoices(contact_id);

    -- Projects-to-contact lookups (Dashboard 4, 6, 8)
    CREATE INDEX idx_xero_projects_contact_id
    ON xero_projects(contact_id);

    -- Contact organization lookups
    CREATE INDEX idx_xero_contacts_org
    ON xero_contacts(organization_id);
    ```

- [ ] **Task 4: Create Covering Indexes for Common Queries** (AC: 3)
  - [ ] Identify top 5 most frequent queries from dashboard requirements
  - [ ] Create covering indexes with INCLUDE columns:
    ```sql
    -- Invoice AR aging query (Dashboard 7)
    CREATE INDEX idx_xero_invoices_ar_aging
    ON xero_invoices(organization_id, status, due_date DESC)
    INCLUDE (total, amount_due, contact_id)
    WHERE type = 'ACCREC' AND status IN ('AUTHORISED', 'PAID', 'PARTPAID');

    -- WIP calculation query (Dashboard 4, 8)
    CREATE INDEX idx_xero_project_time_entries_billable
    ON xero_project_time_entries(project_id, status)
    INCLUDE (duration_minutes, charge_rate_amount)
    WHERE status = 'APPROVED';
    ```
  - [ ] Use partial indexes with WHERE clause for subset filtering

- [ ] **Task 5: Create Utility Indexes** (AC: 2)
  - [ ] Add indexes for admin and utility queries:
    ```sql
    -- Last updated tracking for ETL
    CREATE INDEX idx_xero_invoices_updated
    ON xero_invoices(updated_at DESC);

    CREATE INDEX idx_xero_contacts_updated
    ON xero_contacts(updated_at DESC);

    -- Account code lookups (Dashboard 1, 6)
    CREATE INDEX idx_xero_accounts_code
    ON xero_accounts(organization_id, code);

    -- User/staff lookups (Dashboard 4, 8)
    CREATE INDEX idx_xero_users_org
    ON xero_users(organization_id);
    ```

- [ ] **Task 6: Benchmark Query Performance** (AC: 5)
  - [ ] Identify 10 representative dashboard queries
  - [ ] Run EXPLAIN ANALYZE before index creation:
    ```sql
    EXPLAIN ANALYZE
    SELECT invoice_date, SUM(total) as revenue
    FROM xero_invoices
    WHERE organization_id = 'org-123'
    AND invoice_date >= '2024-01-01'
    AND status = 'AUTHORISED'
    GROUP BY invoice_date;
    ```
  - [ ] Record execution time and plan (Seq Scan vs Index Scan)
  - [ ] Create indexes
  - [ ] Run same queries with EXPLAIN ANALYZE after indexing
  - [ ] Document performance improvements:
    - [ ] Target: 50-90% query time reduction
    - [ ] Verify Index Scan used instead of Seq Scan
    - [ ] Check for Bitmap Heap Scan on composite indexes

- [ ] **Task 7: Verify Index Usage** (AC: 4)
  - [ ] Query PostgreSQL system catalogs to verify indexes exist:
    ```sql
    SELECT
        tablename,
        indexname,
        indexdef
    FROM pg_indexes
    WHERE schemaname = 'public'
    AND tablename LIKE 'xero_%'
    ORDER BY tablename, indexname;
    ```
  - [ ] Verify index sizes are reasonable:
    ```sql
    SELECT
        schemaname,
        tablename,
        indexname,
        pg_size_pretty(pg_relation_size(indexrelid)) as index_size
    FROM pg_stat_user_indexes
    WHERE schemaname = 'public'
    ORDER BY pg_relation_size(indexrelid) DESC;
    ```
  - [ ] Check for duplicate or redundant indexes
  - [ ] Remove any overlapping indexes

- [ ] **Task 8: Monitor Database Size** (AC: 8)
  - [ ] Record database size before index creation:
    ```sql
    SELECT pg_size_pretty(pg_database_size(current_database()));
    ```
  - [ ] Create indexes
  - [ ] Record database size after index creation
  - [ ] Calculate overhead percentage
  - [ ] Document in Supabase monitoring dashboard
  - [ ] Verify storage remains under 400MB alert threshold

- [ ] **Task 9: Version Control Migration** (AC: 6)
  - [ ] Export all index DDL to migration file
  - [ ] Add comments documenting purpose of each index:
    ```sql
    -- Dashboard 7: AR Aging - filters by organization and date range
    CREATE INDEX idx_xero_invoices_org_date ...
    ```
  - [ ] Test migration on local database
  - [ ] Commit to Git: `supabase/migrations/YYYYMMDD_add_performance_indexes.sql`
  - [ ] Document index maintenance procedures (REINDEX, VACUUM)

## Dev Notes

### Index Strategy

**Dashboard Query Patterns (from QA review):**

1. **Dashboard 1** (Income vs Expenses):
   - Query: xero_bank_transactions filtered by organization_id + date
   - Missing index: (organization_id, date DESC)

2. **Dashboard 2-3** (Budget Views):
   - Query: xero_invoices filtered by organization_id + invoice_date + status
   - Missing index: (organization_id, invoice_date DESC, status)

3. **Dashboard 4** (WIP by Team):
   - Query: xero_projects + xero_project_time_entries joins
   - Missing indexes: project_id, status on time_entries

4. **Dashboard 7** (AR Aging):
   - Query: xero_invoices WHERE status IN (...) + due_date calculations
   - Missing index: (status, due_date)

### Index Naming Convention

Follow PostgreSQL best practices:
- **Single column**: `idx_{table}_{column}`
- **Composite**: `idx_{table}_{col1}_{col2}`
- **Covering**: `idx_{table}_{purpose}` (e.g., `idx_xero_invoices_ar_aging`)
- **Partial**: Add `_partial` suffix if WHERE clause used

### B-Tree vs Other Index Types

**B-Tree** (default): Use for equality and range queries
- Best for: `=`, `<`, `>`, `BETWEEN`, `ORDER BY`
- All indexes in this story use B-Tree

**GIN/GiST**: Not needed unless JSONB/full-text search
- xero_invoices.line_items (JSONB) may benefit from GIN in future
- Not in scope for this story

### Partial Indexes for Efficiency

Use WHERE clauses to index only active/relevant data:
```sql
-- Only index unbilled invoices (reduces index size)
CREATE INDEX idx_xero_invoices_unbilled
ON xero_invoices(organization_id, invoice_date)
WHERE status IN ('AUTHORISED', 'SUBMITTED');
```

**Trade-off**: Faster queries on subset, but requires query to match WHERE clause

### Index Maintenance

**Auto-vacuum**: Supabase/PostgreSQL handles automatically
**Manual REINDEX**: Only needed after bulk updates
**Monitoring**: Use `pg_stat_user_indexes` to track index usage:
```sql
SELECT
    schemaname,
    tablename,
    indexname,
    idx_scan as index_scans,
    idx_tup_read as tuples_read,
    idx_tup_fetch as tuples_fetched
FROM pg_stat_user_indexes
WHERE schemaname = 'public'
ORDER BY idx_scan DESC;
```

### Performance Benchmarking

**Target Metrics (NFR9):**
- **Standard queries**: <2 seconds
- **Complex aggregations**: <5 seconds
- **Dashboard load**: <3 seconds total

**Before Indexes** (Expected based on 5,741 contacts):
- Simple SELECT with org filter: ~500ms (Seq Scan)
- Date range + status filter: ~1,500ms (Seq Scan)

**After Indexes** (Expected):
- Simple SELECT with org filter: ~50ms (Index Scan)
- Date range + status filter: ~200ms (Bitmap Index Scan)

**Improvement**: 80-90% faster queries

## Testing

**Testing Standards:**
Performance testing required for infrastructure changes.

**Test Plan:**

1. **Baseline Performance Test**:
   ```sql
   -- Measure BEFORE indexing
   EXPLAIN (ANALYZE, BUFFERS)
   SELECT /* Dashboard 7 AR Aging */
       contact_id,
       SUM(amount_due) as total_outstanding,
       MIN(due_date) as oldest_due_date
   FROM xero_invoices
   WHERE organization_id = 'org-123'
   AND status IN ('AUTHORISED', 'PARTPAID')
   GROUP BY contact_id
   ORDER BY total_outstanding DESC
   LIMIT 20;
   ```
   Record: Execution time, buffers read, plan type

2. **Create Indexes**

3. **Post-Index Performance Test**:
   Run same query, record improvements

4. **Index Usage Test**:
   ```sql
   -- Verify index is actually used
   SELECT indexrelname, idx_scan, idx_tup_read
   FROM pg_stat_user_indexes
   WHERE indexrelname = 'idx_xero_invoices_ar_aging';
   ```

5. **Regression Test**:
   Ensure existing queries still work correctly (no broken queries)

**Success Criteria:**
- ✅ All queries use Index Scan (not Seq Scan)
- ✅ Query time reduced by >50%
- ✅ No queries slower than before
- ✅ Database size increase <20%

## Dependencies

**Blocks:**
- NFR9 compliance: Dashboard queries must be <2 seconds
- Production deployment: Cannot deploy without performance indexes

**Depends On:**
- Story 1.3: Supabase database schema (completed)
- Story 1.3.1: Organizations table (optional but recommended for FK constraints)

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-30 | 1.0 | Created from QA review findings (Story 1.3 INDEX-001) | Quinn (QA) |

## Implementation Notes

**Estimated Effort**: 2-3 hours
- 1 hour: Write index DDL statements
- 30 minutes: Run benchmarks before/after
- 30 minutes: Verify indexes + test queries
- 30 minutes: Migration file + commit to Git

**Risk Assessment**: Low
- Risk: Index creation locks table (briefly)
- Mitigation: Use CONCURRENTLY flag for large tables
- Risk: Indexes consume storage (~10-20% increase)
- Mitigation: Monitor database size, remove unused indexes

**Production Deployment**:
```sql
-- Use CONCURRENTLY to avoid locking table during index creation
CREATE INDEX CONCURRENTLY idx_xero_invoices_org_date
ON xero_invoices(organization_id, invoice_date DESC);
```

**Note**: CONCURRENTLY prevents table locks but takes longer. Use during business hours.
