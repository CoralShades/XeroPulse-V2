# Story 1.2: Deploy n8n Workflow Automation Service

## Status
**Draft**

## Story
**As a** data engineer,
**I want** n8n deployed on VPS with persistent storage and web UI access,
**So that** I can build and schedule Xero data sync workflows.

## Acceptance Criteria

1. n8n container running via Docker Compose with persistent volume for workflow storage
2. n8n web UI accessible at https://n8n.[domain] with HTTPS enabled
3. Basic authentication configured for n8n UI (username/password protection)
4. n8n credential encryption enabled with environment variable key
5. Docker resource limits configured (1.5GB RAM cap for n8n container)
6. n8n service auto-restarts on failure (Docker restart policy: unless-stopped)
7. Workflow storage directory backed up in weekly VPS snapshot
8. Test workflow created and executed successfully ("Hello World" HTTP request)

## Tasks / Subtasks

- [ ] **Task 1: Create Docker Compose Configuration for n8n** (AC: 1, 5, 6)
  - [ ] Create `docker-compose.yml` file in `/opt/xeropulse/` directory
  - [ ] Define n8n service with official n8n Docker image
  - [ ] Configure persistent volume for workflow storage (`/home/.n8n`)
  - [ ] Set memory limit to 1.5GB for n8n container
  - [ ] Configure restart policy to `unless-stopped`
  - [ ] Set required environment variables (timezone, webhook URL, encryption key)

- [ ] **Task 2: Configure n8n Environment Variables** (AC: 2, 3, 4)
  - [ ] Create `.env` file for n8n configuration
  - [ ] Set `N8N_BASIC_AUTH_ACTIVE=true` for web UI protection
  - [ ] Configure `N8N_BASIC_AUTH_USER` and `N8N_BASIC_AUTH_PASSWORD`
  - [ ] Generate and set `N8N_ENCRYPTION_KEY` for credential encryption
  - [ ] Configure `N8N_HOST` to `n8n.[domain]`
  - [ ] Set `N8N_PROTOCOL=https` for HTTPS access
  - [ ] Configure `WEBHOOK_URL` to `https://n8n.[domain]`
  - [ ] Set `GENERIC_TIMEZONE` to `Australia/Sydney`

- [ ] **Task 3: Configure Reverse Proxy for HTTPS Access** (AC: 2)
  - [ ] Install and configure Nginx or Caddy as reverse proxy
  - [ ] Create proxy configuration for `n8n.[domain]` → `localhost:5678`
  - [ ] Configure SSL certificate from Let's Encrypt for `n8n.[domain]`
  - [ ] Enable HTTPS redirect (HTTP → HTTPS)
  - [ ] Configure proxy headers for WebSocket support
  - [ ] Test HTTPS access to n8n web UI

- [ ] **Task 4: Start n8n Container and Verify Operation** (AC: 1, 6)
  - [ ] Run `docker compose up -d` to start n8n
  - [ ] Verify n8n container is running: `docker ps`
  - [ ] Check n8n logs for startup errors: `docker compose logs n8n`
  - [ ] Verify persistent volume is mounted correctly
  - [ ] Test auto-restart by stopping container manually
  - [ ] Confirm container restarts automatically

- [ ] **Task 5: Verify Credential Encryption** (AC: 4)
  - [ ] Access n8n web UI at https://n8n.[domain]
  - [ ] Create test credentials (e.g., HTTP Basic Auth)
  - [ ] Verify credentials are stored encrypted in database
  - [ ] Check that encryption key cannot be changed after first credentials created
  - [ ] Document encryption key securely (password manager)

- [ ] **Task 6: Create and Execute Test Workflow** (AC: 8)
  - [ ] Log into n8n web UI using basic auth credentials
  - [ ] Create new workflow named "Hello World Test"
  - [ ] Add HTTP Request node with GET request to `https://httpbin.org/get`
  - [ ] Add Schedule Trigger node (run once for testing)
  - [ ] Execute workflow manually and verify success
  - [ ] Check execution logs for successful HTTP response
  - [ ] Save workflow to persistent storage
  - [ ] Verify workflow persists after container restart

- [ ] **Task 7: Configure Workflow Storage Backup** (AC: 7)
  - [ ] Verify `/opt/xeropulse/` directory is included in VPS snapshot
  - [ ] Document workflow storage location in infrastructure docs
  - [ ] Test workflow restoration by copying `.n8n` directory to new location
  - [ ] Verify backed-up workflows load correctly after restoration

- [ ] **Task 8: Document n8n Deployment Configuration** (AC: All)
  - [ ] Document n8n access URL and credentials
  - [ ] Document Docker Compose configuration details
  - [ ] Document environment variables and encryption key storage
  - [ ] Document reverse proxy configuration
  - [ ] Document workflow backup and restoration procedure
  - [ ] Add documentation to `docs/infrastructure/n8n-setup.md`

## Dev Notes

### Deployment Architecture

**n8n Deployment Model:**
- **Container:** Official n8n Docker image from `n8nio/n8n:latest`
- **Orchestration:** Docker Compose for service management
- **Region:** VPS in Australia Pacific (Sydney) for data residency [Source: deployment-architecture.md]
- **Instance Type:** Shared VPS with resource limits (1.5GB RAM cap)
- [Source: deployment-architecture.md#n8n-etl-service-deployment]

**Service Configuration:**
```yaml
# Docker Compose excerpt from architecture
services:
  n8n:
    image: n8nio/n8n:latest
    container_name: n8n-xeropulse
    restart: unless-stopped
    ports:
      - "5678:5678"
    environment:
      - N8N_BASIC_AUTH_ACTIVE=true
      - N8N_BASIC_AUTH_USER=${N8N_USER}
      - N8N_BASIC_AUTH_PASSWORD=${N8N_PASSWORD}
      - N8N_ENCRYPTION_KEY=${N8N_ENCRYPTION_KEY}
      - N8N_HOST=n8n.xeropulse.com
      - N8N_PROTOCOL=https
      - WEBHOOK_URL=https://n8n.xeropulse.com
      - GENERIC_TIMEZONE=Australia/Sydney
    volumes:
      - n8n_data:/home/node/.n8n
    deploy:
      resources:
        limits:
          memory: 1.5G
```
[Source: deployment-architecture.md#n8n-cloud-instance-configuration]

### Security Configuration

**Authentication:**
- Basic HTTP authentication for web UI access (username/password)
- No OAuth or SSO integration in MVP (future enhancement)
- Credentials stored in `.env` file (not in version control)
- [Source: security-architecture.md#authentication-identity-management]

**Credential Encryption:**
- All n8n credentials (API keys, OAuth tokens) encrypted at rest
- Encryption key stored as environment variable `N8N_ENCRYPTION_KEY`
- **CRITICAL:** Encryption key cannot be changed after first credential is created
- Generate encryption key: `openssl rand -base64 32`
- [Source: deployment-architecture.md#workflow-version-control]

**HTTPS Configuration:**
- SSL/TLS termination at reverse proxy (Nginx or Caddy)
- TLS 1.3 minimum [Source: security-architecture.md#encryption-strategy]
- Certificate from Let's Encrypt (same wildcard cert as Story 1.1)
- WebSocket support required for n8n web UI functionality

### Resource Limits

**Memory Allocation:**
- **Limit:** 1.5GB RAM (prevents n8n from consuming all VPS resources)
- **Reason:** VPS has 4GB total RAM; n8n shares with other services (Metabase/Superset)
- **Monitoring:** Track memory usage via monitoring from Story 1.1
- [Source: deployment-architecture.md#n8n-cloud-instance-configuration]

**CPU Allocation:**
- No explicit CPU limit (n8n will use available CPU as needed)
- Expected usage: Low CPU except during workflow execution bursts

**Storage:**
- Persistent volume for `/home/node/.n8n` directory
- Expected size: < 1GB for workflows, credentials, and execution logs
- Growth: Monitor storage usage as workflows and execution history accumulate

### Workflow Storage & Backup

**Persistent Storage:**
- Docker named volume: `n8n_data` mounted to `/home/node/.n8n`
- Contains: workflows, credentials (encrypted), execution logs, settings
- **CRITICAL:** Volume must persist across container restarts/upgrades
- [Source: deployment-architecture.md#workflow-version-control]

**Backup Strategy:**
- Workflow data included in weekly VPS snapshot (Story 1.1)
- Additional backup: Manually export workflows as JSON from n8n UI
- Version control: Consider storing workflow JSON in Git repository (future enhancement)
- [Source: deployment-architecture.md#data-backup-and-recovery]

### Reverse Proxy Configuration

**Nginx Configuration Example:**
```nginx
server {
    listen 443 ssl http2;
    server_name n8n.xeropulse.com;

    ssl_certificate /etc/letsencrypt/live/xeropulse.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/xeropulse.com/privkey.pem;

    location / {
        proxy_pass http://localhost:5678;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # WebSocket support for n8n UI
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }
}
```
[Source: deployment-architecture.md#ssl-tls-and-domain-setup]

**Alternative: Caddy Configuration (Simpler)**
```
n8n.xeropulse.com {
    reverse_proxy localhost:5678
}
```

### External API Integration Notes

**Xero API Integration (Story 1.4 Dependency):**
- n8n will be configured with Xero OAuth2 credentials in Story 1.4
- Xero API endpoints: `/Invoices`, `/Contacts`, `/Transactions`, `/Payments`, `/Accounts`
- Rate limits: 10,000 API calls/day, 5 calls/second
- [Source: external-apis.md#xero-accounting-api-integration]

**XPM API Integration (Story 1.5+ Dependency):**
- n8n will connect to XPM API v2 for project management data
- Authentication: API Key + Basic Auth
- Rate limits: 1,000 requests/hour
- [Source: external-apis.md#xpm-practice-management-api-integration]

**Webhook Support:**
- n8n webhook URL: `https://n8n.xeropulse.com/webhook/{workflow-id}`
- Xero webhooks can trigger workflows for real-time sync (future enhancement)
- [Source: external-apis.md#webhook-integration-patterns]

### Dependencies

**From Story 1.1:**
- VPS with Docker and Docker Compose installed ✅
- Domain DNS configured for `n8n.[domain]` subdomain
- Let's Encrypt wildcard SSL certificate available
- Firewall allowing ports 80, 443 (HTTPS traffic) ✅

**For Future Stories:**
- Story 1.4: Configure Xero OAuth2 credentials in n8n
- Story 1.5: Build ETL workflows in n8n for Xero → Supabase sync
- Story 1.6: Metabase/Superset deployment (also on VPS)

### Project Structure Notes

**File Locations:**
- Docker Compose file: `/opt/xeropulse/docker-compose.yml`
- Environment file: `/opt/xeropulse/.env` (sensitive, not in Git)
- n8n data volume: Docker managed volume `n8n_data`
- Reverse proxy config: `/etc/nginx/sites-available/n8n.xeropulse.com` (Nginx) or `/etc/caddy/Caddyfile` (Caddy)
- Documentation: `docs/infrastructure/n8n-setup.md` (to be created)

### Important Configuration Notes

**Timezone Setting:**
- Set `GENERIC_TIMEZONE=Australia/Sydney` to ensure workflow schedules align with business hours
- Affects cron triggers and time-based workflow execution

**Webhook URL:**
- Must be publicly accessible HTTPS URL for external services (Xero webhooks)
- Format: `https://n8n.xeropulse.com/webhook/{workflow-id}`
- n8n generates unique webhook IDs for each webhook trigger node

**Encryption Key:**
- **CRITICAL:** Once the first credential is saved in n8n, the encryption key is locked
- Changing the encryption key later will make existing credentials unreadable
- Store encryption key in password manager and `.env` file backup

### Common Pitfalls

1. **WebSocket Connections:** n8n web UI requires WebSocket support in reverse proxy. Without `proxy_http_version 1.1` and `Upgrade` headers, UI will not load correctly.

2. **Encryption Key Loss:** If encryption key is lost, all saved credentials become unreadable. n8n will require re-entering all credentials.

3. **Memory Limits:** Without memory limit, n8n can consume all VPS RAM during large workflow executions, causing OOM kills.

4. **Workflow Persistence:** Ensure named volume is used (not bind mount) to prevent workflow data loss during container recreation.

5. **Basic Auth Timing:** n8n basic auth must be configured BEFORE first access. Cannot be enabled later without resetting n8n database.

### Testing

**Testing Standards:**

Since this is an infrastructure deployment story, traditional software testing frameworks are not applicable. Use infrastructure validation and functional testing.

**Testing Approach:**
- **Manual Verification Tests:** Execute validation steps to confirm each acceptance criterion
- **Infrastructure Tests:** Verify Docker container operation, persistent storage, HTTPS access
- **Functional Tests:** Create and execute test workflow to validate n8n functionality
- **Security Tests:** Verify basic authentication, credential encryption, HTTPS enforcement

**Test Execution:**

1. **Container Operation Test (AC: 1, 6):**
   - Verify container is running: `docker ps | grep n8n`
   - Check container restart policy: `docker inspect n8n-xeropulse | grep -A 5 RestartPolicy`
   - Stop container: `docker stop n8n-xeropulse`
   - Wait 10 seconds and verify auto-restart: `docker ps | grep n8n`
   - Check container logs for clean startup: `docker compose logs n8n`

2. **HTTPS Access Test (AC: 2):**
   - Access n8n web UI at `https://n8n.xeropulse.com`
   - Verify HTTPS connection (check browser padlock icon)
   - Verify SSL certificate validity: `curl -vI https://n8n.xeropulse.com 2>&1 | grep "SSL certificate"`
   - Test HTTP → HTTPS redirect: `curl -I http://n8n.xeropulse.com` (should return 301/302)

3. **Authentication Test (AC: 3):**
   - Attempt access without credentials (should prompt for username/password)
   - Log in with configured credentials (should succeed)
   - Log in with incorrect credentials (should fail)
   - Verify basic auth header in browser developer tools

4. **Credential Encryption Test (AC: 4):**
   - Create test HTTP Basic Auth credentials in n8n UI
   - Access n8n database/file storage directly
   - Verify credentials are encrypted (not plaintext)
   - Attempt to decrypt credentials without encryption key (should fail)

5. **Resource Limit Test (AC: 5):**
   - Check memory limit: `docker stats n8n-xeropulse --no-stream`
   - Verify limit is 1.5GB (1536 MB)
   - Trigger workflow with large dataset and monitor memory usage
   - Verify container is killed if memory exceeds limit (OOM protection)

6. **Workflow Test (AC: 8):**
   - Create "Hello World" workflow with HTTP Request node
   - Configure GET request to `https://httpbin.org/get`
   - Execute workflow manually and verify success
   - Check response contains valid JSON
   - Verify workflow saves and persists after container restart

7. **Persistent Storage Test (AC: 1, 7):**
   - Create test workflow and save in n8n
   - Stop n8n container: `docker stop n8n-xeropulse`
   - Restart n8n container: `docker start n8n-xeropulse`
   - Verify test workflow still exists in n8n UI
   - Check workflow backup in VPS snapshot (verify directory is included)

8. **Reverse Proxy & WebSocket Test (AC: 2):**
   - Access n8n web UI and verify UI loads completely
   - Test workflow editor (drag and drop nodes)
   - Verify execution logs update in real-time (WebSocket connection)
   - Check browser console for WebSocket connection errors (should be none)

**Test Documentation:**
- Document all test results in `docs/qa/1.2-n8n-deployment-tests.md`
- Include screenshots of successful n8n UI access
- Record Docker container status and resource usage
- Document any failures or configuration adjustments needed

**Testing Tools:**
- `curl` for HTTPS and authentication testing
- `docker` CLI for container inspection and management
- Browser developer tools for WebSocket and network inspection
- `docker stats` for resource monitoring

**No automated testing framework required for this story.**

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-22 | 1.0 | Initial story creation from Epic 1 | Bob (Scrum Master) |

## Dev Agent Record

_This section will be populated by the development agent during implementation._

### Agent Model Used
_To be filled by Dev Agent_

### Debug Log References
_To be filled by Dev Agent_

### Completion Notes List
_To be filled by Dev Agent_

### File List
_To be filled by Dev Agent_

## QA Results

_This section will be populated by the QA Agent after implementation._
