# Story 1.1: Provision VPS Infrastructure and Docker Environment

## Status
**Draft**

## Story
**As a** DevOps engineer,
**I want** a production VPS with Docker Compose orchestration configured,
**So that** we have a secure, monitored hosting environment for n8n and Superset services.

## Acceptance Criteria

1. VPS provisioned on Hetzner Cloud (4GB RAM, 2 vCPU, 40GB storage) or DigitalOcean equivalent
2. SSH access configured with key-based authentication (password login disabled)
3. Basic firewall rules implemented (allow ports 22, 80, 443; deny all other inbound traffic)
4. Docker and Docker Compose installed and verified operational
5. HTTPS/SSL configured with Let's Encrypt wildcard certificate for domain
6. Basic monitoring established (CPU, RAM, disk usage alerts via simple script or free monitoring service)
7. Weekly automated VPS snapshot schedule configured
8. Documentation created: VPS access credentials, firewall rules, monitoring setup

## Tasks / Subtasks

- [ ] **Task 1: Provision VPS Instance** (AC: 1)
  - [ ] Select VPS provider (Hetzner Cloud preferred, DigitalOcean acceptable)
  - [ ] Create VPS instance with specifications: 4GB RAM, 2 vCPU, 40GB storage
  - [ ] Configure initial root access
  - [ ] Document VPS details (IP address, provider, region, specifications)

- [ ] **Task 2: Configure SSH Security** (AC: 2)
  - [ ] Generate SSH key pair for server access
  - [ ] Add SSH public key to authorized_keys on VPS
  - [ ] Disable password authentication in `/etc/ssh/sshd_config`
  - [ ] Restart SSH service and verify key-based login works
  - [ ] Test that password login is disabled

- [ ] **Task 3: Implement Firewall Rules** (AC: 3)
  - [ ] Install ufw (Uncomplicated Firewall) or iptables
  - [ ] Configure firewall to allow SSH (port 22)
  - [ ] Configure firewall to allow HTTP (port 80)
  - [ ] Configure firewall to allow HTTPS (port 443)
  - [ ] Set default policy to deny all other inbound traffic
  - [ ] Enable firewall and verify rules are active
  - [ ] Test firewall by attempting connections on allowed and blocked ports

- [ ] **Task 4: Install Docker and Docker Compose** (AC: 4)
  - [ ] Update package manager (apt update)
  - [ ] Install Docker using official installation method
  - [ ] Add current user to docker group for non-root access
  - [ ] Install Docker Compose plugin or standalone binary
  - [ ] Verify Docker installation: `docker --version`
  - [ ] Verify Docker Compose installation: `docker compose version`
  - [ ] Run test container to confirm Docker is operational: `docker run hello-world`

- [ ] **Task 5: Configure HTTPS/SSL with Let's Encrypt** (AC: 5)
  - [ ] Install Certbot for Let's Encrypt certificate management
  - [ ] Configure domain DNS records to point to VPS IP
  - [ ] Obtain wildcard SSL certificate using Certbot with DNS challenge
  - [ ] Configure automatic certificate renewal (cron job or systemd timer)
  - [ ] Verify certificate is valid and auto-renewal is scheduled
  - [ ] Test HTTPS access to domain

- [ ] **Task 6: Establish Basic Monitoring** (AC: 6)
  - [ ] Choose monitoring solution (simple script, netdata, or free service like UptimeRobot)
  - [ ] Install monitoring agent/script for CPU, RAM, and disk usage tracking
  - [ ] Configure alert thresholds (e.g., CPU > 80%, RAM > 85%, Disk > 90%)
  - [ ] Set up notification channel (email or webhook) for alerts
  - [ ] Test monitoring by generating test alerts
  - [ ] Document monitoring access and alert configuration

- [ ] **Task 7: Configure Automated VPS Snapshots** (AC: 7)
  - [ ] Enable automated snapshots in VPS provider dashboard (if available)
  - [ ] Configure weekly snapshot schedule (e.g., every Sunday at 2 AM)
  - [ ] Set snapshot retention policy (minimum 4 weeks)
  - [ ] Verify first snapshot is created successfully
  - [ ] Document snapshot schedule and restoration procedure

- [ ] **Task 8: Create Infrastructure Documentation** (AC: 8)
  - [ ] Document VPS access credentials (SSH key location, user, IP)
  - [ ] Document firewall configuration and rules
  - [ ] Document monitoring setup and alert configuration
  - [ ] Document SSL certificate renewal process
  - [ ] Document snapshot schedule and restoration procedure
  - [ ] Store documentation in secure location (repository or password manager)

## Dev Notes

### Architecture Discrepancy Alert
**IMPORTANT:** The Epic mentions "Superset services" but the Architecture documentation specifies "Metabase" as the BI platform. This needs clarification before implementation. For now, follow Epic specifications and prepare infrastructure for both n8n and the BI platform (name TBD).

**Resolution Needed:** Confirm with Product Owner whether to use Apache Superset (Epic) or Metabase (Architecture docs).

### Infrastructure Requirements

**VPS Provider Selection:**
- **Preferred:** Hetzner Cloud (cost-effective, European data centers)
- **Alternative:** DigitalOcean (widely supported, good documentation)
- **Minimum Specifications:** 4GB RAM, 2 vCPU, 40GB SSD storage
- **Region:** Australia Pacific (Sydney) preferred for data residency compliance [Source: deployment-architecture.md#production-environment-architecture]

**Docker Configuration:**
- Docker version: Latest stable from official Docker repository
- Docker Compose: Use Docker Compose V2 (plugin format) for modern syntax
- Resource limits will be configured per container in Story 1.2 (n8n) and Story 1.6 (Superset/Metabase)
- [Source: tech-stack.md - Build Tool section]

### Security Configuration

**SSH Hardening:**
- Disable root login via password (require key-based authentication only)
- Edit `/etc/ssh/sshd_config`: Set `PasswordAuthentication no` and `PermitRootLogin prohibit-password`
- Use Ed25519 key type for SSH keys: `ssh-keygen -t ed25519`
- [Source: security-architecture.md#network-security-infrastructure-protection]

**Firewall Rules:**
- Use ufw (Uncomplicated Firewall) for Ubuntu/Debian or firewalld for CentOS
- Default policy: DENY all incoming, ALLOW all outgoing
- Explicit ALLOW rules: 22/tcp (SSH), 80/tcp (HTTP), 443/tcp (HTTPS)
- Block all other inbound traffic including ICMP ping (optional hardening)
- [Source: security-architecture.md#infrastructure-security]

**SSL/TLS Configuration:**
- Certificate provider: Let's Encrypt (free, auto-renewable)
- Certificate type: Wildcard certificate for `*.xeropulse.com` domain
- Protocol: TLS 1.3 minimum [Source: security-architecture.md#encryption-strategy]
- Certificate renewal: Automated via Certbot cron job (runs twice daily)
- DNS challenge method required for wildcard certificates (not HTTP challenge)
- [Source: deployment-architecture.md#security-configuration]

### Monitoring Requirements

**Metrics to Monitor:**
- CPU usage (alert threshold: > 80% for 5 minutes)
- RAM usage (alert threshold: > 85% for 5 minutes)
- Disk usage (alert threshold: > 90%)
- [Source: deployment-architecture.md#monitoring-observability]

**Monitoring Options:**
1. **Simple Script:** Custom bash script with cron job + email alerts (zero cost)
2. **Netdata:** Free, real-time monitoring with web UI (lightweight)
3. **UptimeRobot:** Free tier for basic uptime monitoring (external service)

**Alert Channels:**
- Email notifications for critical alerts
- Webhook integration for future Slack/Discord notifications (optional)

### Backup Strategy

**Snapshot Configuration:**
- Frequency: Weekly (every Sunday at 2:00 AM local time)
- Retention: Minimum 4 weeks (recommended: 8 weeks if provider allows)
- Backup scope: Full VPS disk snapshot (includes Docker volumes)
- [Source: deployment-architecture.md#data-backup-and-recovery]

**Restoration Testing:**
- Test snapshot restoration process after first backup completes
- Document restoration steps for disaster recovery

### Documentation Requirements

**Required Documentation Items:**
1. **VPS Access Credentials:**
   - VPS provider account details
   - VPS IP address and region
   - SSH private key location and passphrase (if used)
   - SSH username (typically `root` or `ubuntu`)

2. **Firewall Configuration:**
   - List of allowed ports and protocols
   - Firewall management commands (ufw/iptables)
   - Emergency firewall disable procedure

3. **Monitoring Setup:**
   - Monitoring tool access credentials
   - Alert threshold values
   - Notification channel configuration
   - Dashboard URL (if applicable)

4. **SSL Certificate Management:**
   - Domain DNS configuration
   - Certbot renewal command
   - Certificate expiration date
   - Manual renewal procedure (fallback)

5. **Snapshot Schedule:**
   - Snapshot frequency and timing
   - Snapshot retention policy
   - Restoration procedure steps
   - Provider-specific snapshot commands

**Documentation Storage:**
- Primary: Repository under `docs/infrastructure/vps-setup.md`
- Sensitive credentials: Password manager or encrypted vault (NOT in repository)

### Project Structure Notes

**Missing Documentation:**
- `docs/architecture/unified-project-structure.md` or `source-tree.md` not found in repository
- No specific file path guidance available for infrastructure documentation
- **Recommended:** Create `docs/infrastructure/` directory for VPS and deployment documentation

**File Locations for This Story:**
- Infrastructure documentation: `docs/infrastructure/vps-setup.md` (to be created)
- SSL certificates: `/etc/letsencrypt/` (standard Certbot location on VPS)
- Docker Compose files: `/opt/xeropulse/` or `/home/deploy/xeropulse/` (to be decided in Story 1.2)

### Dependencies and Next Steps

**Dependencies:**
- Domain name registered and DNS access available for wildcard certificate
- VPS provider account with payment method configured
- Decision on BI platform (Superset vs. Metabase) needed before Story 1.6

**Next Stories:**
- Story 1.2: Deploy n8n Workflow Automation Service (depends on Docker environment from this story)
- Story 1.6: Deploy BI Dashboard Engine (depends on Docker environment from this story)

### Testing

**Testing Standards:**

Since this is an infrastructure provisioning story, traditional software testing frameworks (Jest, Playwright) are not applicable. Instead, use infrastructure validation and verification testing.

**Testing Approach:**
- **Manual Verification Tests:** Execute validation commands to confirm each acceptance criterion
- **Infrastructure Tests:** Functional tests of SSH, firewall, Docker, SSL, monitoring, and backups
- **Security Tests:** Verify security hardening (SSH key-only, firewall rules, HTTPS)

**Test Execution:**
1. **SSH Security Test:**
   - Attempt password login (should fail)
   - Attempt SSH key login (should succeed)
   - Verify only authorized keys work

2. **Firewall Test:**
   - Use `nmap` or `telnet` to test allowed ports (22, 80, 443) - should respond
   - Test blocked port (e.g., 3306, 5432) - should timeout/refuse connection
   - Verify firewall status: `sudo ufw status verbose`

3. **Docker Installation Test:**
   - Run `docker --version` (should return version)
   - Run `docker compose version` (should return version)
   - Run `docker run hello-world` (should pull and execute successfully)

4. **SSL Certificate Test:**
   - Run `certbot certificates` to list installed certificates
   - Verify certificate validity: `curl https://n8n.xeropulse.com -v` (check TLS version and certificate)
   - Check certificate expiration date (should be > 60 days)

5. **Monitoring Test:**
   - Verify monitoring service is running: `systemctl status <service>` or check web UI
   - Generate test CPU load and verify alert triggers
   - Verify alert notification received

6. **Snapshot Test:**
   - Check VPS provider dashboard for scheduled snapshots
   - Verify first snapshot completed successfully
   - Test snapshot restoration to a test VPS (optional but recommended)

**Test Documentation:**
- Document all test results in `docs/qa/1.1-infrastructure-tests.md`
- Include screenshots of successful tests where applicable
- Record any failures or deviations from expected results

**Testing Tools:**
- `nmap` for port scanning tests
- `curl` for SSL/TLS verification
- `stress` or `stress-ng` for CPU/RAM load testing
- Provider dashboard for snapshot verification

**No automated testing framework required for this story.**

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-22 | 1.0 | Initial story creation from Epic 1 | Bob (Scrum Master) |

## Dev Agent Record

_This section will be populated by the development agent during implementation._

### Agent Model Used
_To be filled by Dev Agent_

### Debug Log References
_To be filled by Dev Agent_

### Completion Notes List
_To be filled by Dev Agent_

### File List
_To be filled by Dev Agent_

## QA Results

_This section will be populated by the QA Agent after implementation._
