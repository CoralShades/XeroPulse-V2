# Story 1.4: Integrate Xero API with OAuth2 Authentication

## Status
**Draft**

## Story
**As a** data engineer,
**I want** n8n workflow successfully authenticating to Xero API and fetching financial data,
**So that** we can extract invoices, contacts, transactions, payments, and accounts for dashboard use.

## Acceptance Criteria

1. Xero developer account created with OAuth2 app credentials (Client ID, Client Secret)
2. n8n Xero OAuth2 credentials configured and successfully authorized (OAuth flow completed)
3. Test workflow created fetching 100 invoices from production Xero organization
4. Xero API rate limit handling implemented (exponential backoff on 429 errors, batch requests where possible)
5. Workflow successfully extracts data from minimum 5 Xero API endpoints: Invoices, Contacts, Transactions (Bank Transactions), Payments, Accounts
6. Data structure validated (JSON responses match expected Xero API schema)
7. Error handling tested (network failures, invalid credentials, API rate limits trigger appropriate retries/alerts)
8. Documentation created: Xero API endpoints used, OAuth2 setup steps, rate limit strategy

## Tasks / Subtasks

- [ ] **Task 1: Create Xero Developer Account and OAuth App** (AC: 1)
  - [ ] Sign up at https://developer.xero.com
  - [ ] Create new OAuth 2.0 app in Xero Developer Portal
  - [ ] Configure app name: "XeroPulse ETL"
  - [ ] Set redirect URI: `https://n8n.[domain]/rest/oauth2-credential/callback`
  - [ ] Select required scopes: `accounting.transactions`, `accounting.contacts`, `accounting.reports.read`, `accounting.settings`
  - [ ] Generate Client ID and Client Secret
  - [ ] Document credentials securely (password manager)

- [ ] **Task 2: Configure Xero Credentials in n8n** (AC: 2)
  - [ ] Access n8n web UI at https://n8n.[domain]
  - [ ] Navigate to Credentials → Add Credential
  - [ ] Select "Xero OAuth2 API" credential type
  - [ ] Enter Xero Client ID and Client Secret
  - [ ] Enter redirect URI (same as Xero app config)
  - [ ] Click "Connect my account" to initiate OAuth flow
  - [ ] Authorize XeroPulse app in Xero authorization page
  - [ ] Select production Xero organization for connection
  - [ ] Verify OAuth flow completes successfully
  - [ ] Test credential connection in n8n

- [ ] **Task 3: Create Test Workflow for Xero Invoices** (AC: 3, 6)
  - [ ] Create new n8n workflow: "Test Xero Invoices Extract"
  - [ ] Add Manual Trigger node
  - [ ] Add Xero node with "Get All" operation for Invoices
  - [ ] Configure: Fetch 100 invoices, order by UpdatedDateUTC DESC
  - [ ] Execute workflow and verify 100 invoices retrieved
  - [ ] Inspect JSON response structure
  - [ ] Validate response contains: InvoiceID, InvoiceNumber, Date, Total, Status, Contact
  - [ ] Save workflow

- [ ] **Task 4: Implement Rate Limit Handling** (AC: 4)
  - [ ] Add Function node to check for HTTP 429 status codes
  - [ ] Implement exponential backoff logic: 2s, 4s, 8s, 16s retries
  - [ ] Extract `Retry-After` header from 429 responses
  - [ ] Add Wait node with dynamic delay based on rate limit headers
  - [ ] Configure max retry attempts (3 attempts)
  - [ ] Test rate limit handling by triggering deliberate rate limit
  - [ ] Verify workflow waits and retries correctly

- [ ] **Task 5: Extract Data from All Required Endpoints** (AC: 5, 6)
  - [ ] Create workflow nodes for each endpoint:
    - [ ] **Contacts:** GET /Contacts (customer/supplier data)
    - [ ] **Bank Transactions:** GET /BankTransactions
    - [ ] **Payments:** GET /Payments
    - [ ] **Accounts:** GET /Accounts (chart of accounts)
  - [ ] Configure each node with pagination (100 items per page)
  - [ ] Execute workflow and verify data extraction from all 5 endpoints
  - [ ] Validate JSON structure matches Xero API documentation
  - [ ] Document sample response structure for each endpoint

- [ ] **Task 6: Implement Error Handling** (AC: 7)
  - [ ] Add Error Trigger node to workflow
  - [ ] Create error handling workflow:
    - [ ] Catch network failures (timeout, connection refused)
    - [ ] Catch authentication errors (401 Unauthorized)
    - [ ] Catch rate limit errors (429 Too Many Requests)
    - [ ] Catch API errors (400, 500 responses)
  - [ ] Add notification node (email/webhook) for critical errors
  - [ ] Test each error scenario:
    - [ ] Disconnect internet and verify network error handling
    - [ ] Use invalid credentials and verify 401 handling
    - [ ] Trigger rate limit and verify 429 handling
  - [ ] Log all errors to n8n execution log

- [ ] **Task 7: Validate Xero API Data Structure** (AC: 6)
  - [ ] Compare API responses to Xero API documentation
  - [ ] Document field mappings for Supabase schema:
    - [ ] Invoices: InvoiceID → source_id, Total → amount, Date → transaction_date
    - [ ] Contacts: ContactID → source_id, Name → contact_name
    - [ ] Payments: PaymentID → source_id, Amount → amount, Date → payment_date
    - [ ] Accounts: AccountID → source_id, Code → account_code, Name → account_name
  - [ ] Verify date fields are ISO 8601 format
  - [ ] Verify decimal precision for monetary amounts
  - [ ] Document any data transformation requirements

- [ ] **Task 8: Document Xero Integration** (AC: 8)
  - [ ] Document Xero OAuth2 setup steps
  - [ ] Document required scopes and permissions
  - [ ] List all Xero API endpoints used with parameters
  - [ ] Document rate limit strategy (5 calls/second, 10,000/day)
  - [ ] Document error handling and retry logic
  - [ ] Document field mappings from Xero to Supabase
  - [ ] Add documentation to `docs/infrastructure/xero-integration.md`

## Dev Notes

### Xero API Architecture

**API Version:**
- Xero API v2.0 (current stable)
- Base URL: `https://api.xero.com/api.xro/2.0/`
- [Source: external-apis.md#xero-accounting-api-integration]

**Rate Limits:**
- 10,000 API calls per day (per organization)
- 5 calls per second (burst limit)
- 60 requests per minute (sustained)
- HTTP 429 response when rate limit exceeded
- `Retry-After` header indicates wait time in seconds
- [Source: external-apis.md#xero-accounting-api-integration]

### OAuth 2.0 Authentication

**OAuth Flow:**
1. User clicks "Connect to Xero" in n8n
2. Redirect to Xero authorization page
3. User authorizes app and selects organization
4. Xero redirects to n8n callback URL with authorization code
5. n8n exchanges code for access token + refresh token
6. Access token expires after 30 minutes
7. Refresh token valid for 60 days
8. [Source: external-apis.md#authentication-flow]

**Required Scopes:**
```yaml
accounting.transactions: Read invoices, bills, bank transactions
accounting.contacts: Read customer and supplier information
accounting.reports.read: Access to P&L, Balance Sheet, Trial Balance reports
accounting.settings: Read organization settings and preferences
```
[Source: external-apis.md#required-scopes-for-xeropulse]

**OAuth Configuration in n8n:**
- Credential Type: "Xero OAuth2 API"
- Grant Type: Authorization Code
- Authorization URL: `https://login.xero.com/identity/connect/authorize`
- Access Token URL: `https://identity.xero.com/connect/token`
- Redirect URI: `https://n8n.[domain]/rest/oauth2-credential/callback`
- [Source: external-apis.md]

### Xero API Endpoints

**Core Endpoints for XeroPulse:**

```yaml
GET /Invoices:
  Description: Sales and purchase invoices
  Parameters: page, order, If-Modified-Since, where
  Returns: InvoiceID, InvoiceNumber, Type, Date, DueDate, Total, AmountPaid, Status, Contact

GET /Contacts:
  Description: Customer and supplier information
  Parameters: page, order, If-Modified-Since
  Returns: ContactID, Name, EmailAddress, Phones, Addresses, IsSupplier, IsCustomer

GET /BankTransactions:
  Description: Bank account transactions
  Parameters: page, order, If-Modified-Since, where
  Returns: BankTransactionID, Type, Date, LineAmountTypes, LineItems, Total, Status

GET /Payments:
  Description: Payment transactions and allocations
  Parameters: page, order, If-Modified-Since
  Returns: PaymentID, Invoice, Account, Date, Amount, Reference

GET /Accounts:
  Description: Chart of accounts
  Parameters: order, where
  Returns: AccountID, Code, Name, Type, TaxType, Status, EnablePaymentsToAccount

GET /Organisations:
  Description: Organization settings (for tenant verification)
  Returns: OrganisationID, Name, LegalName, BaseCurrency, Timezone
```
[Source: external-apis.md#key-endpoints-used]

**Dashboard-Specific Requirements:**

For detailed endpoint mappings specific to each of the 8 dashboards, including:
- Exact API parameters and filters
- Data transformation formulas (e.g., 52-week rolling averages)
- WIP calculations and service type mappings
- XPM API integration requirements

Refer to the comprehensive endpoint mapping documentation:
- **Primary Reference**: `docs/xero-api-endpoint-mapping.md` (Dashboard-specific endpoints and transformations)
- **Expanded Reference**: `docs/xero-api-endpoint-mapping-expanded.md` (ETL architecture, n8n workflows, error handling patterns)

### Rate Limit Handling Strategy

**Exponential Backoff Implementation:**
```javascript
// n8n Function node for rate limit handling
const maxRetries = 3;
const baseDelay = 2000; // 2 seconds

// Check if response is rate limited
if ($json.statusCode === 429) {
  const retryAfter = $json.headers['retry-after'];
  const attemptNum = $execution.customData.retryCount || 0;

  if (attemptNum >= maxRetries) {
    throw new Error('Max retries exceeded for rate limit');
  }

  // Calculate delay: use Retry-After header or exponential backoff
  const delay = retryAfter
    ? parseInt(retryAfter) * 1000
    : baseDelay * Math.pow(2, attemptNum);

  $execution.customData.retryCount = attemptNum + 1;

  return {
    json: {
      wait: delay,
      retry: true,
      attempt: attemptNum + 1
    }
  };
}
```
[Source: external-apis.md#error-handling-rate-limiting]

**Batching Strategy:**
- Pagination: Request 100 items per page (Xero max)
- Sequential requests: Wait 200ms between requests (5/second limit)
- Parallel requests: Max 2 concurrent endpoints at a time
- [Source: external-apis.md]

### Data Structure Validation

**Invoice Response Sample:**
```json
{
  "InvoiceID": "a4f8e3d2-1234-5678-90ab-cdef12345678",
  "InvoiceNumber": "INV-001",
  "Type": "ACCREC",
  "Date": "2025-10-22T00:00:00",
  "DueDate": "2025-11-22T00:00:00",
  "Total": 5000.00,
  "AmountPaid": 2500.00,
  "AmountDue": 2500.00,
  "Status": "AUTHORISED",
  "Contact": {
    "ContactID": "b5g9f4e3-2345-6789-01bc-def123456789",
    "Name": "ABC Corporation"
  },
  "LineItems": [...]
}
```
[Source: external-apis.md#data-retrieval-patterns]

**Field Mapping to Supabase:**
- `InvoiceID` → `financial_data.source_id`
- `Total` → `financial_data.amount`
- `Date` → `financial_data.transaction_date`
- `Status` → `financial_data.status`
- `Contact.ContactID` → `financial_data.client_id`
- `Contact.Name` → `financial_data.client_name`
- [Source: database-schema.md]

### Error Handling

**Error Types:**

1. **Authentication Errors (401):**
   - Cause: Expired access token, invalid credentials
   - Handling: Attempt token refresh, re-authenticate if refresh fails
   - Alert: Notify admin of authentication failure

2. **Rate Limit Errors (429):**
   - Cause: Exceeded 5 calls/second or 10,000 calls/day
   - Handling: Exponential backoff with `Retry-After` header
   - Alert: Log warning, continue with retry

3. **Network Errors (Timeout, Connection Refused):**
   - Cause: Network connectivity issues, Xero API downtime
   - Handling: Retry 3 times with 5-second delay
   - Alert: Notify admin if all retries fail

4. **API Errors (400, 500):**
   - Cause: Invalid request parameters, Xero server errors
   - Handling: Log error details, skip record, continue workflow
   - Alert: Notify admin of persistent API errors

[Source: external-apis.md#error-handling-rate-limiting]

### Dependencies

**From Previous Stories:**
- Story 1.2: n8n deployed and accessible ✅
- Story 1.3: Supabase schema ready for data insertion ✅

**For Future Stories:**
- Story 1.5: Will use Xero credentials to build automated ETL workflow

### Security Notes

**Credential Storage:**
- Xero Client ID and Secret stored in n8n encrypted credentials
- OAuth tokens stored encrypted using n8n encryption key (from Story 1.2)
- Never log or expose credentials in workflow execution logs
- [Source: security-architecture.md#authentication-identity-management]

**Token Management:**
- Access tokens expire after 30 minutes (automatic refresh by n8n)
- Refresh tokens expire after 60 days (require re-authorization)
- Monitor token expiration and proactively refresh before expiry
- [Source: external-apis.md#authentication-flow]

### Testing

**Testing Standards:**

Functional testing of Xero API integration using n8n workflow execution and validation.

**Testing Approach:**
- OAuth flow validation
- API endpoint connectivity testing
- Rate limit handling verification
- Error scenario testing
- Data structure validation

**Test Execution:**

1. **OAuth Authentication Test (AC: 1, 2):**
   - Complete OAuth flow in n8n
   - Verify redirect to Xero authorization page
   - Verify organization selection works
   - Verify callback to n8n succeeds
   - Verify access token is stored in n8n
   - Test credential with simple API call (GET /Organisation)

2. **Invoice Extraction Test (AC: 3, 6):**
   - Execute test workflow
   - Verify 100 invoices are retrieved
   - Check JSON structure contains required fields
   - Validate data types (dates, decimals, strings)
   - Save response JSON for reference

3. **Multi-Endpoint Test (AC: 5):**
   - Execute workflow extracting from all 5 endpoints
   - Verify each endpoint returns data
   - Count records from each endpoint
   - Compare response structures to Xero API docs
   - Document any schema discrepancies

4. **Rate Limit Handling Test (AC: 4):**
   - Create workflow making rapid successive API calls
   - Trigger rate limit (send >5 requests in 1 second)
   - Verify HTTP 429 response is received
   - Verify exponential backoff executes
   - Verify workflow retries successfully after delay
   - Check execution log for retry attempts

5. **Error Handling Test (AC: 7):**
   - **Test 401 (Invalid Credentials):**
     - Temporarily invalidate OAuth token
     - Execute workflow
     - Verify error is caught and logged
   - **Test Network Failure:**
     - Disable VPS internet temporarily
     - Execute workflow
     - Verify retry logic executes
     - Verify failure notification sent
   - **Test 500 (API Error):**
     - Cannot simulate directly
     - Document expected behavior in error logs

6. **Data Validation Test (AC: 6):**
   - Extract sample invoice
   - Compare fields to Xero API documentation
   - Verify decimal precision (2 decimals for amounts)
   - Verify date format (ISO 8601)
   - Verify contact nesting structure
   - Map fields to Supabase schema

**Test Documentation:**
- Document all test results in `docs/qa/1.4-xero-integration-tests.md`
- Include screenshots of successful OAuth flow
- Save sample JSON responses from each endpoint
- Record rate limit test results
- Document any API schema differences found

**Testing Tools:**
- n8n workflow execution interface
- n8n execution logs
- Browser developer tools (OAuth flow)
- Postman/Insomnia for direct API testing (optional)

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-22 | 1.0 | Initial story creation from Epic 1 | Bob (Scrum Master) |

## Dev Agent Record

_This section will be populated by the development agent during implementation._

### Agent Model Used
_To be filled by Dev Agent_

### Debug Log References
_To be filled by Dev Agent_

### Completion Notes List
_To be filled by Dev Agent_

### File List
_To be filled by Dev Agent_

## QA Results

_This section will be populated by the QA Agent after implementation._
