# Story 1.3: Configure Supabase Project and Database Schema

## Status
**Draft**

## Story
**As a** database administrator,
**I want** Supabase project initialized with normalized schema for Xero financial data,
**So that** n8n workflows can load synchronized data for dashboard queries.

## Acceptance Criteria

1. Supabase project created with AU/NZ region selected for data residency
2. PostgreSQL database schema created with normalized tables: `invoices`, `line_items`, `contacts`, `transactions`, `payments`, `accounts`, `budgets`
3. Primary keys and foreign key relationships defined (e.g., `line_items.invoice_id` references `invoices.id`)
4. Indexes created on frequently filtered fields: `contact_id`, `invoice_date`, `payment_date`, `status` fields
5. Database migration files version-controlled in monorepo `/apps/web/supabase/migrations/`
6. Supabase connection credentials (host, database, user, password) documented securely
7. Test data inserted manually to verify schema (5 sample invoices with line items)
8. Database storage usage monitored (baseline measurement recorded, alert set for 400MB threshold)

## Tasks / Subtasks

- [ ] **Task 1: Create Supabase Project** (AC: 1, 6)
  - [ ] Sign up for Supabase account at https://supabase.com
  - [ ] Create new project with AU/NZ (Sydney) region selected
  - [ ] Configure project name: "xeropulse-production"
  - [ ] Set database password (strong password, 20+ characters)
  - [ ] Wait for project provisioning to complete
  - [ ] Document Supabase project URL and credentials securely

- [ ] **Task 2: Initialize Database Migration Structure** (AC: 5)
  - [ ] Install Supabase CLI: `npm install -g supabase`
  - [ ] Initialize Supabase in project: `supabase init`
  - [ ] Create migration directory structure if not exists
  - [ ] Verify migration files will be stored in `supabase/migrations/`
  - [ ] Configure Supabase connection in project

- [ ] **Task 3: Create Core Database Tables** (AC: 2, 3)
  - [ ] Create migration file for core tables
  - [ ] Define `organizations` table (multi-tenancy support)
  - [ ] Define `users` table with role-based access
  - [ ] Define `invoices` table (Xero invoice data)
  - [ ] Define `line_items` table (invoice line items)
  - [ ] Define `contacts` table (customers/suppliers)
  - [ ] Define `transactions` table (bank transactions)
  - [ ] Define `payments` table (payment records)
  - [ ] Define `accounts` table (chart of accounts)
  - [ ] Define `budgets` table (budget tracking)
  - [ ] Define all primary keys (UUID type)
  - [ ] Define foreign key relationships between tables
  - [ ] Add CHECK constraints for data integrity

- [ ] **Task 4: Create Database Indexes** (AC: 4)
  - [ ] Create index on `invoices.contact_id`
  - [ ] Create index on `invoices.invoice_date`
  - [ ] Create index on `invoices.status`
  - [ ] Create index on `payments.payment_date`
  - [ ] Create index on `payments.status`
  - [ ] Create composite index on `(organization_id, invoice_date DESC)` for dashboard queries
  - [ ] Create covering index on `(contact_id, status)` for contact filtering
  - [ ] Verify index creation in Supabase database editor

- [ ] **Task 5: Apply Database Migration** (AC: 2, 3)
  - [ ] Run migration: `supabase db push`
  - [ ] Verify all tables created successfully
  - [ ] Check primary keys are defined correctly
  - [ ] Check foreign key constraints are active
  - [ ] Verify table structures match schema definition
  - [ ] Commit migration files to version control

- [ ] **Task 6: Insert Test Data** (AC: 7)
  - [ ] Create 1 test organization record
  - [ ] Create 5 test contact records (customers)
  - [ ] Create 5 test invoice records with varying statuses
  - [ ] Create 15 test line_item records (3 per invoice)
  - [ ] Create 3 test payment records
  - [ ] Create 10 test account records (sample chart of accounts)
  - [ ] Verify foreign key relationships work correctly
  - [ ] Query test data to confirm schema integrity

- [ ] **Task 7: Configure Database Monitoring** (AC: 8)
  - [ ] Access Supabase project dashboard
  - [ ] Navigate to Database → Monitoring section
  - [ ] Record baseline storage usage (should be < 10MB initially)
  - [ ] Configure storage alert at 400MB threshold
  - [ ] Enable query performance monitoring
  - [ ] Document monitoring dashboard URL and access

- [ ] **Task 8: Document Database Configuration** (AC: 6, 8)
  - [ ] Document Supabase project URL and region
  - [ ] Document database connection string (service_role and anon keys)
  - [ ] Document migration procedure for future changes
  - [ ] Document test data creation process
  - [ ] Document monitoring and alert configuration
  - [ ] Store sensitive credentials in password manager (NOT in Git)
  - [ ] Add documentation to `docs/infrastructure/supabase-setup.md`

## Dev Notes

### Architecture Context

**Database Platform:**
- **Provider:** Supabase (managed PostgreSQL)
- **Region:** Australia Pacific (Sydney) - AU/NZ data residency [Source: deployment-architecture.md#supabase-infrastructure-setup]
- **Version:** PostgreSQL 15+ (Supabase managed)
- **Tier:** Pro plan ($25/month + usage) [Source: deployment-architecture.md#database-configuration]

**Multi-Tenancy Design:**
- Organization-level data isolation using `organization_id` foreign key on all tables
- Row Level Security (RLS) policies to be implemented in Story 1.8 (authentication)
- [Source: database-schema.md#core-tables-schema]

### Database Schema Design

**Core Tables (Required for AC #2):**

```sql
-- Organizations table (multi-tenancy)
CREATE TABLE organizations (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name VARCHAR(255) NOT NULL,
    xero_tenant_id VARCHAR(100) UNIQUE,
    xero_connected BOOLEAN DEFAULT false,
    last_sync_at TIMESTAMP WITH TIME ZONE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT now(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT now()
);

-- Contacts table (customers/suppliers from Xero)
CREATE TABLE contacts (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    organization_id UUID NOT NULL REFERENCES organizations(id),
    contact_name VARCHAR(255) NOT NULL,
    email VARCHAR(255),
    phone VARCHAR(50),
    source VARCHAR(10) DEFAULT 'xero',
    source_id VARCHAR(100) NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT now(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT now(),
    UNIQUE(organization_id, source, source_id)
);

-- Invoices table (sales/purchase invoices from Xero)
CREATE TABLE invoices (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    organization_id UUID NOT NULL REFERENCES organizations(id),
    contact_id UUID REFERENCES contacts(id),
    invoice_number VARCHAR(100),
    invoice_type VARCHAR(20) CHECK (invoice_type IN ('sales', 'purchase')),
    invoice_date DATE NOT NULL,
    due_date DATE,
    total_amount DECIMAL(15,2) NOT NULL,
    tax_amount DECIMAL(15,2),
    status VARCHAR(20) NOT NULL,
    source VARCHAR(10) DEFAULT 'xero',
    source_id VARCHAR(100) NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT now(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT now(),
    UNIQUE(organization_id, source, source_id)
);

-- Line Items table (invoice line items)
CREATE TABLE line_items (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    invoice_id UUID NOT NULL REFERENCES invoices(id) ON DELETE CASCADE,
    description TEXT,
    quantity DECIMAL(10,2),
    unit_price DECIMAL(15,2),
    line_amount DECIMAL(15,2) NOT NULL,
    tax_amount DECIMAL(15,2),
    account_code VARCHAR(20),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT now()
);

-- Payments table (payment transactions from Xero)
CREATE TABLE payments (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    organization_id UUID NOT NULL REFERENCES organizations(id),
    invoice_id UUID REFERENCES invoices(id),
    payment_date DATE NOT NULL,
    amount DECIMAL(15,2) NOT NULL,
    reference VARCHAR(255),
    status VARCHAR(20) NOT NULL,
    source VARCHAR(10) DEFAULT 'xero',
    source_id VARCHAR(100) NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT now(),
    UNIQUE(organization_id, source, source_id)
);

-- Accounts table (chart of accounts from Xero)
CREATE TABLE accounts (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    organization_id UUID NOT NULL REFERENCES organizations(id),
    account_code VARCHAR(20) NOT NULL,
    account_name VARCHAR(255) NOT NULL,
    account_type VARCHAR(50),
    tax_type VARCHAR(50),
    status VARCHAR(20) DEFAULT 'active',
    source VARCHAR(10) DEFAULT 'xero',
    source_id VARCHAR(100) NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT now(),
    UNIQUE(organization_id, account_code)
);

-- Transactions table (bank transactions from Xero)
CREATE TABLE transactions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    organization_id UUID NOT NULL REFERENCES organizations(id),
    account_id UUID REFERENCES accounts(id),
    transaction_date DATE NOT NULL,
    description TEXT,
    amount DECIMAL(15,2) NOT NULL,
    transaction_type VARCHAR(20),
    status VARCHAR(20),
    source VARCHAR(10) DEFAULT 'xero',
    source_id VARCHAR(100) NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT now(),
    UNIQUE(organization_id, source, source_id)
);

-- Budgets table (budget tracking from Xero)
CREATE TABLE budgets (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    organization_id UUID NOT NULL REFERENCES organizations(id),
    account_id UUID REFERENCES accounts(id),
    period_start DATE NOT NULL,
    period_end DATE NOT NULL,
    budget_amount DECIMAL(15,2) NOT NULL,
    actual_amount DECIMAL(15,2),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT now(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT now()
);
```
[Source: database-schema.md#core-tables-schema]

### Required Indexes (AC #4)

```sql
-- Invoices indexes
CREATE INDEX idx_invoices_contact_id ON invoices(contact_id);
CREATE INDEX idx_invoices_date ON invoices(invoice_date);
CREATE INDEX idx_invoices_status ON invoices(status);
CREATE INDEX idx_invoices_org_date ON invoices(organization_id, invoice_date DESC);

-- Payments indexes
CREATE INDEX idx_payments_payment_date ON payments(payment_date);
CREATE INDEX idx_payments_status ON payments(status);
CREATE INDEX idx_payments_invoice ON payments(invoice_id);

-- Contacts indexes
CREATE INDEX idx_contacts_org ON contacts(organization_id);
CREATE INDEX idx_contacts_source ON contacts(source, source_id);

-- Transactions indexes
CREATE INDEX idx_transactions_org_date ON transactions(organization_id, transaction_date DESC);
CREATE INDEX idx_transactions_account ON transactions(account_id);
```
[Source: database-schema.md#performance-indexes]

### Database Configuration

**Connection Details:**
- **Connection String:** `postgresql://postgres:[password]@db.[project-ref].supabase.co:5432/postgres`
- **Anon Key:** Public API key for client-side queries (RLS enforced)
- **Service Role Key:** Admin API key for server-side operations (bypasses RLS)
- **REST API:** `https://[project-ref].supabase.co/rest/v1/`
- [Source: deployment-architecture.md#supabase-infrastructure-setup]

**Connection Pooling:**
- PgBouncer enabled (Supabase managed)
- Max connections: 200
- Pool size: 20
- Pool mode: Transaction
- [Source: deployment-architecture.md#database-configuration]

### Migration Strategy

**Migration File Structure:**
```
supabase/
├── migrations/
│   ├── 20251022_001_create_organizations.sql
│   ├── 20251022_002_create_contacts.sql
│   ├── 20251022_003_create_invoices.sql
│   ├── 20251022_004_create_line_items.sql
│   ├── 20251022_005_create_payments.sql
│   ├── 20251022_006_create_accounts.sql
│   ├── 20251022_007_create_transactions.sql
│   ├── 20251022_008_create_budgets.sql
│   └── 20251022_009_create_indexes.sql
└── seed.sql (test data)
```
[Source: database-schema.md]

**Migration Commands:**
- Initialize: `supabase init`
- Create migration: `supabase migration new [name]`
- Apply migrations: `supabase db push`
- Reset database: `supabase db reset` (dev only!)
- [Source: deployment-architecture.md]

### Test Data Requirements (AC #7)

**Sample Data to Insert:**
```sql
-- 1 Test Organization
INSERT INTO organizations (name, xero_tenant_id, xero_connected)
VALUES ('Acme Accounting', 'test-tenant-123', true);

-- 5 Test Contacts
INSERT INTO contacts (organization_id, contact_name, email, source_id) VALUES
    ('<org-uuid>', 'ABC Corporation', 'contact@abc.com', 'xero-contact-1'),
    ('<org-uuid>', 'XYZ Services', 'info@xyz.com', 'xero-contact-2'),
    ('<org-uuid>', 'Tech Solutions Ltd', 'hello@tech.com', 'xero-contact-3'),
    ('<org-uuid>', 'Global Enterprises', 'contact@global.com', 'xero-contact-4'),
    ('<org-uuid>', 'Local Business Co', 'info@local.com', 'xero-contact-5');

-- 5 Test Invoices (varying statuses)
INSERT INTO invoices (organization_id, contact_id, invoice_number, invoice_type, invoice_date, total_amount, status, source_id) VALUES
    ('<org-uuid>', '<contact-1-uuid>', 'INV-001', 'sales', '2025-10-01', 5000.00, 'paid', 'xero-inv-1'),
    ('<org-uuid>', '<contact-2-uuid>', 'INV-002', 'sales', '2025-10-05', 3500.00, 'pending', 'xero-inv-2'),
    ('<org-uuid>', '<contact-3-uuid>', 'INV-003', 'sales', '2025-10-10', 7200.00, 'paid', 'xero-inv-3'),
    ('<org-uuid>', '<contact-4-uuid>', 'INV-004', 'sales', '2025-10-15', 1500.00, 'overdue', 'xero-inv-4'),
    ('<org-uuid>', '<contact-5-uuid>', 'INV-005', 'sales', '2025-10-20', 4800.00, 'pending', 'xero-inv-5');

-- 15 Test Line Items (3 per invoice)
-- Insert line items for each invoice with descriptions, quantities, and amounts
```

### Storage Monitoring (AC #8)

**Storage Metrics:**
- **Initial Baseline:** < 10MB (empty schema + test data)
- **Alert Threshold:** 400MB (set in Supabase dashboard)
- **Expected Growth:** ~500KB per day with daily syncs
- **Database Size Query:**
```sql
SELECT pg_size_pretty(pg_database_size('postgres')) AS database_size;
```
[Source: deployment-architecture.md#database-monitoring]

### Dependencies

**From Previous Stories:**
- None (Supabase is independent infrastructure)

**For Future Stories:**
- Story 1.4-1.5: n8n will connect to Supabase to insert Xero data
- Story 1.6: Metabase/Superset will connect to Supabase for dashboard queries
- Story 1.8: Supabase Auth configuration and RLS policies

### Important Notes

**Data Residency Compliance:**
- **CRITICAL:** Must select AU/NZ (Sydney) region during project creation
- Region cannot be changed after project creation
- Required for Australian Privacy Act compliance
- [Source: deployment-architecture.md#production-environment-architecture]

**Idempotent Sync Design:**
- `UNIQUE(organization_id, source, source_id)` constraint on all data tables
- Enables n8n to use `UPSERT` operations without creating duplicates
- Supports re-running sync workflows without data duplication
- [Source: database-schema.md#important-constraints]

**Future RLS Policies (Not in This Story):**
- Row Level Security will be configured in Story 1.8
- RLS policies enforce organization isolation and role-based access
- Current story creates schema only; security layer comes later
- [Source: security-architecture.md#authorization-access-control]

### Testing

**Testing Standards:**

Infrastructure validation testing using Supabase SQL Editor and CLI tools.

**Testing Approach:**
- SQL queries to verify schema creation
- Test data insertion to verify foreign key constraints
- Index verification using PostgreSQL system catalogs
- Storage monitoring verification

**Test Execution:**

1. **Schema Creation Test (AC: 2, 3):**
   ```sql
   -- List all tables
   SELECT table_name FROM information_schema.tables
   WHERE table_schema = 'public' ORDER BY table_name;

   -- Verify expected tables exist
   -- Expected: organizations, contacts, invoices, line_items, payments, accounts, transactions, budgets

   -- Check foreign key constraints
   SELECT
       tc.table_name,
       kcu.column_name,
       ccu.table_name AS foreign_table_name,
       ccu.column_name AS foreign_column_name
   FROM information_schema.table_constraints AS tc
   JOIN information_schema.key_column_usage AS kcu
       ON tc.constraint_name = kcu.constraint_name
   JOIN information_schema.constraint_column_usage AS ccu
       ON ccu.constraint_name = tc.constraint_name
   WHERE tc.constraint_type = 'FOREIGN KEY';
   ```

2. **Index Creation Test (AC: 4):**
   ```sql
   -- List all indexes
   SELECT
       tablename,
       indexname,
       indexdef
   FROM pg_indexes
   WHERE schemaname = 'public'
   ORDER BY tablename, indexname;

   -- Verify expected indexes exist
   -- Check for: idx_invoices_contact_id, idx_invoices_date, idx_invoices_status, etc.
   ```

3. **Test Data Insertion (AC: 7):**
   ```sql
   -- Insert test organization
   INSERT INTO organizations (name, xero_tenant_id, xero_connected)
   VALUES ('Test Org', 'test-123', true) RETURNING id;

   -- Insert test contacts and verify count
   SELECT COUNT(*) FROM contacts; -- Should be 5

   -- Insert test invoices and verify relationships
   SELECT COUNT(*) FROM invoices; -- Should be 5
   SELECT COUNT(*) FROM line_items; -- Should be 15

   -- Test foreign key constraint
   SELECT i.invoice_number, c.contact_name
   FROM invoices i
   JOIN contacts c ON i.contact_id = c.id;
   -- Should return 5 rows with proper joins
   ```

4. **Storage Monitoring Test (AC: 8):**
   ```sql
   -- Check database size
   SELECT pg_size_pretty(pg_database_size('postgres')) AS size;

   -- Check individual table sizes
   SELECT
       relname AS table_name,
       pg_size_pretty(pg_total_relation_size(relid)) AS total_size
   FROM pg_catalog.pg_statio_user_tables
   ORDER BY pg_total_relation_size(relid) DESC;
   ```

5. **Migration Version Control Test (AC: 5):**
   ```bash
   # Verify migration files exist
   ls -la supabase/migrations/

   # Check migration history
   supabase migration list

   # Verify migrations are in Git
   git status supabase/migrations/
   ```

6. **Connection Credentials Test (AC: 6):**
   - Access Supabase dashboard → Project Settings → API
   - Verify anon key is documented
   - Verify service_role key is documented
   - Test connection string works:
   ```bash
   psql "postgresql://postgres:[password]@db.[ref].supabase.co:5432/postgres" -c "SELECT version();"
   ```

**Test Documentation:**
- Document all test results in `docs/qa/1.3-supabase-schema-tests.md`
- Include screenshots of Supabase dashboard showing tables and indexes
- Record database size measurements
- Document any schema adjustments or corrections

**Testing Tools:**
- Supabase SQL Editor (web interface)
- `psql` CLI for direct PostgreSQL access
- Supabase CLI for migration testing
- `supabase db diff` to verify schema matches migrations

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-22 | 1.0 | Initial story creation from Epic 1 | Bob (Scrum Master) |

## Dev Agent Record

_This section will be populated by the development agent during implementation._

### Agent Model Used
_To be filled by Dev Agent_

### Debug Log References
_To be filled by Dev Agent_

### Completion Notes List
_To be filled by Dev Agent_

### File List
_To be filled by Dev Agent_

## QA Results

_This section will be populated by the QA Agent after implementation._
