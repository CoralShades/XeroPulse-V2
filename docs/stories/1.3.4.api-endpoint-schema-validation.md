# Story 1.3.4: Validate Database Schema Against Xero API Endpoint Mappings

## Status
**Draft**

## Story Type
**Product Owner / Architecture Validation Story**

## Story
**As a** product owner,
**I want** the existing xero_* database schema validated against the documented API endpoint mappings,
**So that** we ensure all dashboard data requirements can be met and identify any schema gaps.

## Acceptance Criteria

1. All tables in `docs/xero-api-endpoint-mapping.md` cross-referenced with actual xero_* schema
2. Each of 8 dashboards validated for data completeness:
   - Dashboard 1: Income vs Expenses - data sources verified
   - Dashboard 2: Monthly Invoicing to Budget - data sources verified
   - Dashboard 3: YTD/MTD Budget Views - data sources verified
   - Dashboard 4: Work In Progress by Team - data sources verified
   - Dashboard 5: ATO Lodgment Status - Suntax integration decision made
   - Dashboard 6: Services Analysis - data sources verified
   - Dashboard 7: Debtors/AR Aging - data sources verified
   - Dashboard 8: Client Recoverability - data sources verified
3. Gap analysis document created identifying missing tables/columns
4. Decision matrix created for JSONB vs normalized tables (line_items, payments)
5. Service type taxonomy mapping strategy defined (XPM task codes → service categories)
6. Team assignment strategy documented (staff → teams for WIP dashboard)
7. Suntax API integration feasibility assessed for Dashboard 5
8. Schema enhancement recommendations prioritized (must-have vs nice-to-have)

## Tasks / Subtasks

- [ ] **Task 1: Dashboard 1 - Income vs Expenses Validation** (AC: 2)
  - [ ] **Income (Blue Bars)** - Payments API
    - [ ] Required: Weekly cash receipts
    - [ ] Source: `GET /api.xro/2.0/Payments`
    - [ ] Schema check: Do we have payments data?
      - [ ] ⚠️ FINDING: No dedicated `payments` table
      - [ ] ⚠️ `xero_invoices.payments` is JSONB array
      - [ ] Decision required: Extract to separate table or query JSONB?
  - [ ] **Wages (Yellow Line)** - P&L Report
    - [ ] Required: Weekly wages expense with 52-week rolling average
    - [ ] Source: `GET /api.xro/2.0/Reports/ProfitAndLoss`
    - [ ] Schema check: Do we have P&L report data?
      - [ ] ✅ `xero_profit_and_loss_reports` table exists
      - [ ] Verify: Contains `report_rows` JSONB with account breakdowns
  - [ ] **Expenses (Gray Line)** - P&L Report
    - [ ] Same as Wages, different account codes
    - [ ] ✅ Covered by `xero_profit_and_loss_reports`
  - [ ] **Gap Analysis**: None (JSONB payments decision needed)

- [ ] **Task 2: Dashboard 2 & 3 - Budget Views Validation** (AC: 2)
  - [ ] **Actual Invoicing**
    - [ ] Source: `GET /api.xro/2.0/Payments`
    - [ ] ⚠️ Same payments issue as Dashboard 1
  - [ ] **Budget Targets**
    - [ ] Required: Monthly budget amounts from Budget Summary report
    - [ ] Source: `GET /api.xro/2.0/Reports/BudgetSummary`
    - [ ] Schema check:
      - [ ] ✅ `xero_budgets` table exists
      - [ ] Verify: Contains budget_lines JSONB with monthly amounts
  - [ ] **Gap Analysis**: Payments extraction strategy needed

- [ ] **Task 3: Dashboard 4 - WIP by Team Validation** (AC: 2, 5, 6)
  - [ ] **Jobs List**
    - [ ] Source: XPM `/practicemanager/3.1/job.api/list`
    - [ ] ✅ `xero_projects` table exists
  - [ ] **Time Entries**
    - [ ] Source: XPM `/practicemanager/3.1/time.api/list`
    - [ ] ✅ `xero_project_time_entries` table exists
  - [ ] **Costs/Disbursements**
    - [ ] Source: XPM `/practicemanager/3.1/cost.api/list`
    - [ ] ✅ `xero_project_expenses` table exists
  - [ ] **Progress Invoices**
    - [ ] Source: XPM `/practicemanager/3.1/invoice.api/list`
    - [ ] ❌ MISSING: No `xero_xpm_invoices` table
    - [ ] Gap: XPM invoices different from Xero Accounting invoices
  - [ ] **Staff/Team Mapping**
    - [ ] ✅ `xero_users` table exists
    - [ ] ❓ team_name field present?
    - [ ] Decision: Create staff_team_mappings lookup table?
  - [ ] **Gap Analysis**: XPM invoices table + team mapping strategy

- [ ] **Task 4: Dashboard 5 - ATO Lodgment Status Validation** (AC: 2, 7)
  - [ ] **Suntax API Research**
    - [ ] Contact Suntax support for API availability
    - [ ] Document API endpoints (if available)
    - [ ] Assess authentication method
    - [ ] Identify data format (JSON, XML, CSV)
  - [ ] **Alternative Solutions**
    - [ ] Option A: Manual CSV upload workflow
      - [ ] Create `ato_lodgment_status` table
      - [ ] Build admin CSV import feature
    - [ ] Option B: Track in XPM using custom fields
      - [ ] Use xero_projects with lodgment categories
      - [ ] Requires manual XPM data entry
    - [ ] Option C: Defer to future phase (post-MVP)
  - [ ] **Decision Required**: Product Owner to choose approach
  - [ ] **Gap Analysis**: Entire Dashboard 5 data source undefined

- [ ] **Task 5: Dashboard 6 - Services Analysis Validation** (AC: 2, 5)
  - [ ] **Time Entries by Service**
    - [ ] Source: XPM `/practicemanager/3.1/time.api/list`
    - [ ] ✅ `xero_project_time_entries` table exists
  - [ ] **Task/Category Mapping**
    - [ ] Source: XPM `/practicemanager/3.1/task.api/list`
    - [ ] ❌ MISSING: No `xero_tasks` or `xero_categories` table
    - [ ] Gap: Cannot map time entries to service types
  - [ ] **Service Type Taxonomy**
    - [ ] Required: Map XPM task codes → (EOFY, SMSF, Bookkeeping, ITR, BAS, Advisory, etc.)
    - [ ] Decision: Create `service_type_mappings` lookup table:
      ```sql
      CREATE TABLE service_type_mappings (
          id UUID PRIMARY KEY,
          xpm_task_code VARCHAR(50),
          xpm_task_name VARCHAR(200),
          service_type VARCHAR(100), -- EOFY, SMSF, etc.
          organization_id UUID
      );
      ```
    - [ ] Document population strategy (admin UI, CSV import, manual SQL)
  - [ ] **Invoices by Service**
    - [ ] Same XPM invoice gap as Dashboard 4
  - [ ] **Gap Analysis**: XPM tasks table + service_type_mappings table + XPM invoices

- [ ] **Task 6: Dashboard 7 - AR Aging Validation** (AC: 2)
  - [ ] **Invoices (Accounts Receivable)**
    - [ ] Source: `GET /api.xro/2.0/Invoices`
    - [ ] ✅ `xero_invoices` table exists
    - [ ] Verify: Contains InvoiceID, ContactID, DueDate, AmountDue, Status
  - [ ] **Contacts (Debtors)**
    - [ ] Source: `GET /api.xro/2.0/Contacts`
    - [ ] ✅ `xero_contacts` table exists
  - [ ] **Payments (DSO Calculation)**
    - [ ] Source: `GET /api.xro/2.0/Payments`
    - [ ] ⚠️ Same payments extraction issue
  - [ ] **Gap Analysis**: Payments extraction (JSONB vs table)

- [ ] **Task 7: Dashboard 8 - Client Recoverability Validation** (AC: 2)
  - [ ] **Time Entries by Client**
    - [ ] ✅ `xero_project_time_entries` exists (via project → client join)
  - [ ] **Costs by Client**
    - [ ] ✅ `xero_project_expenses` exists
  - [ ] **Progress Invoices**
    - [ ] ❌ Same XPM invoice gap
  - [ ] **Gap Analysis**: XPM invoices table

- [ ] **Task 8: Create Comprehensive Gap Analysis Document** (AC: 3)
  - [ ] Compile findings into structured document:
    ```markdown
    # Database Schema Gap Analysis
    ## Summary
    - Tables Present: 16
    - Tables Validated: 16
    - Critical Gaps: 3
    - Nice-to-Have Gaps: 2

    ## Critical Gaps
    1. **XPM Invoices Table** (xero_xpm_invoices)
       - Impacts: Dashboards 4, 6, 8
       - Severity: High
       - Recommendation: Create table with XPM invoice.api data

    2. **Payments Extraction** (from xero_invoices.payments JSONB)
       - Impacts: Dashboards 1, 2, 3, 7
       - Severity: High
       - Recommendation: Create separate payments table OR create JSONB query views

    3. **Service Type Taxonomy** (service_type_mappings table)
       - Impacts: Dashboard 6
       - Severity: Medium
       - Recommendation: Create lookup table for XPM task → service type

    ## Nice-to-Have Gaps
    4. **Team Assignment Mapping** (staff_team_mappings table)
       - Impacts: Dashboard 4
       - Severity: Low
       - Alternative: Use xero_users.team_name field if present

    5. **XPM Tasks/Categories Tables**
       - Impacts: Dashboard 6 (service analysis)
       - Severity: Low
       - Alternative: Hard-code task → service mapping in ETL
    ```
  - [ ] Add visual schema diagram showing gaps

- [ ] **Task 9: Create JSONB vs Normalized Decision Matrix** (AC: 4)
  - [ ] Document trade-offs:
    | Aspect | JSONB (Current) | Normalized Table (Alternative) |
    |--------|----------------|--------------------------------|
    | **Payments** |  |  |
    | ETL Complexity | ✅ Simple (direct API → JSONB) | ⚠️ Complex (extract, transform, insert) |
    | Query Performance | ⚠️ JSONB queries slower | ✅ Indexed table queries faster |
    | Dashboard Queries | ⚠️ Complex JSONB path syntax | ✅ Simple SQL JOINs |
    | Data Integrity | ⚠️ Application-level validation | ✅ FK constraints, typed columns |
    | Schema Evolution | ⚠️ JSONB schema changes harder | ✅ Add columns easily |
    | **Line Items** |  |  |
    | ETL Complexity | ✅ Simple | ⚠️ 1:Many insert complexity |
    | Query Performance | ⚠️ JSONB aggregations slow | ✅ GROUP BY on table fast |
    | Storage Efficiency | ✅ Compact JSONB | ⚠️ Separate rows = more storage |
  - [ ] **Recommendation**:
    - [ ] Keep JSONB for line_items (rarely queried individually)
    - [ ] Extract payments to separate table (frequently queried, 4 dashboards need it)

- [ ] **Task 10: Prioritize Schema Enhancements** (AC: 8)
  - [ ] Create prioritization matrix:
    | Enhancement | Dashboards Impacted | Effort | Priority | Recommended Story |
    |-------------|---------------------|--------|----------|-------------------|
    | Create xero_xpm_invoices table | 4, 6, 8 | Medium | ⭐⭐⭐ CRITICAL | Story 1.5.1 |
    | Extract payments to table | 1, 2, 3, 7 | Medium | ⭐⭐⭐ CRITICAL | Story 1.3.5 |
    | Create service_type_mappings | 6 | Low | ⭐⭐ HIGH | Story 1.6.1 |
    | Create xero_tasks table | 6 | Low | ⭐ MEDIUM | Story 1.5.2 |
    | Create staff_team_mappings | 4 | Low | ⭐ LOW | Story 1.5.3 |
    | Suntax integration | 5 | High | ⚠️ RESEARCH | Story 1.7.1 |
  - [ ] Product Owner approves prioritization

- [ ] **Task 11: Update Architecture Documentation** (AC: 3)
  - [ ] Update `docs/architecture/database-schema.md`:
    - [ ] Add section for xero_* table structure
    - [ ] Document JSONB column usage and rationale
    - [ ] Add ER diagram showing actual schema
    - [ ] Document identified gaps and roadmap
  - [ ] Update `docs/xero-api-endpoint-mapping-expanded.md`:
    - [ ] Add "Schema Validation" section for each dashboard
    - [ ] Mark ✅ validated, ⚠️ needs work, ❌ missing
  - [ ] Create new doc: `docs/architecture/schema-evolution-roadmap.md`
    - [ ] List identified gaps
    - [ ] Map to future stories (1.3.5, 1.5.1, 1.5.2, etc.)

## Dev Notes

### Validation Methodology

This story is **research and documentation**, not implementation.

**Approach:**
1. For each dashboard in `docs/xero-api-endpoint-mapping.md`:
   - Identify required data fields
   - Map to Xero/XPM API endpoints
   - Check if corresponding xero_* table exists
   - Verify table has required columns
   - Document any gaps

2. Create gap analysis with severity ratings:
   - **Critical**: Blocks dashboard functionality completely
   - **High**: Limits dashboard features significantly
   - **Medium**: Workarounds exist but suboptimal
   - **Low**: Nice-to-have, not essential for MVP

3. Recommend solutions for each gap

### Current Schema Summary (from QA Review)

**Existing Tables (16):**
- ✅ xero_invoices (Xero Accounting)
- ✅ xero_contacts (Xero Accounting)
- ✅ xero_accounts (Xero Accounting)
- ✅ xero_bank_transactions (Xero Accounting)
- ✅ xero_budgets (Xero Accounting)
- ✅ xero_profit_and_loss_reports (Xero Reports)
- ✅ xero_projects (XPM)
- ✅ xero_project_time_entries (XPM)
- ✅ xero_project_expenses (XPM)
- ✅ xero_users (XPM)
- ✅ profiles (Supabase Auth)
- ✅ dashboards (Metabase config)
- ✅ dashboard_permissions (RBAC)
- ✅ xero_connections (OAuth tokens)
- ✅ xero_data_cache (Performance cache)
- ✅ crm_leads (Custom/external)

**JSONB Columns:**
- xero_invoices.line_items (array)
- xero_invoices.payments (array)
- xero_budgets.budget_lines (array)
- xero_profit_and_loss_reports.report_rows (nested)
- xero_bank_transactions.line_items (array)

### Expected Findings

Based on preliminary analysis:

**Likely Gaps:**
1. ❌ XPM invoices (separate from Xero Accounting invoices)
2. ❌ XPM tasks/categories (for service type mapping)
3. ⚠️ Payments (in JSONB, may need extraction)
4. ⚠️ Service type taxonomy (requires lookup table)
5. ⚠️ Team assignments (may need lookup table)

**Likely OK:**
- ✅ Invoice data (Dashboard 7 AR Aging)
- ✅ Time entries (Dashboards 4, 6, 8)
- ✅ Projects (Dashboards 4, 6, 8)
- ✅ Budgets (Dashboards 2, 3)
- ✅ P&L reports (Dashboard 1)

## Dependencies

**Blocks:**
- Story 1.4-1.9 implementation: Need to know schema gaps before building dashboards
- ETL workflow design: Must know which tables to populate

**Depends On:**
- Story 1.3: Supabase schema created (completed)
- `docs/xero-api-endpoint-mapping.md`: API mapping document (exists)

**Outputs:**
- Story 1.3.5: Create payments table (if needed)
- Story 1.5.1: Create XPM invoices table
- Story 1.5.2: Create XPM tasks table
- Story 1.6.1: Create service_type_mappings table
- Story 1.7.1: Suntax integration research

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-30 | 1.0 | Created from QA review recommendations | Quinn (QA) |

## Implementation Notes

**Estimated Effort**: 6-8 hours (research/documentation)
- 4 hours: Validate each dashboard against schema
- 2 hours: Create gap analysis document
- 1 hour: Decision matrix for JSONB vs tables
- 1 hour: Update architecture documentation

**Deliverables:**
- ✅ Gap analysis document (`docs/architecture/schema-gap-analysis.md`)
- ✅ Decision matrix for JSONB strategy
- ✅ Prioritized enhancement roadmap
- ✅ Updated database-schema.md
- ✅ 3-5 new story files for identified gaps

**Who Should Do This:**
- **Primary**: Product Owner (business requirements validation)
- **Support**: Architect (schema design decisions)
- **Review**: Dev Lead (implementation feasibility)
