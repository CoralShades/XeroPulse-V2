# Story 1.5: Build Automated Xero-to-Supabase ETL Workflow

## Status
**Draft**

## Story
**As a** data engineer,
**I want** n8n workflow automatically syncing Xero financial data to Supabase every 2 hours,
**So that** dashboards display fresh data without manual intervention.

## Acceptance Criteria

1. n8n workflow scheduled to run every 2 hours (cron: `0 */2 * * *`)
2. Workflow extracts data from Xero API endpoints: Invoices, Line Items, Contacts, Transactions, Payments, Accounts, Budgets
3. Data transformation logic implemented: Map Xero JSON to Supabase table columns, handle null values, parse dates correctly
4. Upsert logic configured: Update existing records if changed, insert new records, avoid duplicates
5. Sync execution logs generated: timestamp, records processed, errors encountered, duration
6. Workflow completes within 30 minutes for typical dataset (95% of syncs within 2-hour window)
7. Error handling: Retry failed API calls 3 times with exponential backoff, log failures for manual review
8. Success criteria: 7 consecutive days with 95%+ successful sync executions (tested Week 2)
9. Data freshness timestamp recorded in Supabase (`last_sync_at` metadata table)

## Tasks / Subtasks

- [ ] **Task 1: Create Scheduled ETL Workflow** (AC: 1)
  - [ ] Create new n8n workflow: "Xero to Supabase Sync"
  - [ ] Add Cron Trigger node with schedule: `0 */2 * * *` (every 2 hours)
  - [ ] Set timezone to `Australia/Sydney`
  - [ ] Enable workflow to run on schedule
  - [ ] Test manual execution before enabling schedule

- [ ] **Task 2: Extract Invoices from Xero** (AC: 2, 3)
  - [ ] Add Xero node: GET /Invoices with `If-Modified-Since` parameter
  - [ ] Configure pagination (100 invoices per page)
  - [ ] Add Function node to transform Xero invoice JSON to Supabase schema
  - [ ] Map fields: InvoiceID→source_id, Total→amount, Date→transaction_date, etc.
  - [ ] Handle null values (use COALESCE or default values)
  - [ ] Parse dates from ISO 8601 to PostgreSQL timestamp format

- [ ] **Task 3: Extract Line Items from Invoices** (AC: 2, 3)
  - [ ] Add Function node to extract LineItems array from invoices
  - [ ] Transform each line item to Supabase `line_items` schema
  - [ ] Link line items to parent invoice via `invoice_id` foreign key
  - [ ] Calculate line amounts (quantity × unit_price)

- [ ] **Task 4: Extract Contacts, Transactions, Payments, Accounts** (AC: 2, 3)
  - [ ] Add Xero nodes for each endpoint with `If-Modified-Since` filtering
  - [ ] Transform each dataset to respective Supabase table schema
  - [ ] Handle incremental sync (only fetch records modified since last sync)
  - [ ] Store last sync timestamp for next execution

- [ ] **Task 5: Implement Upsert Logic** (AC: 4)
  - [ ] Add Supabase nodes with INSERT ... ON CONFLICT ... UPDATE
  - [ ] Use composite unique constraint: `(organization_id, source, source_id)`
  - [ ] Update `updated_at` timestamp on conflict
  - [ ] Verify no duplicate records created

- [ ] **Task 6: Implement Sync Logging** (AC: 5, 9)
  - [ ] Create `sync_sessions` table in Supabase (metadata table)
  - [ ] Log sync start: timestamp, workflow_id, status='running'
  - [ ] Count records processed from each endpoint
  - [ ] Log sync completion: end timestamp, total records, errors, duration
  - [ ] Update organization `last_sync_at` timestamp

- [ ] **Task 7: Implement Error Handling** (AC: 7)
  - [ ] Add Error Trigger node
  - [ ] Retry failed API calls 3 times with exponential backoff
  - [ ] Log errors to `sync_logs` table with error details
  - [ ] Send notification for critical failures (email/webhook)
  - [ ] Continue workflow even if individual endpoints fail (partial sync)

- [ ] **Task 8: Performance Optimization** (AC: 6)
  - [ ] Batch Supabase inserts (50-100 records per batch)
  - [ ] Parallel execution for independent endpoints (Contacts, Accounts)
  - [ ] Test workflow execution time with realistic dataset
  - [ ] Verify completion within 30 minutes

## Dev Notes

### ETL Workflow Design

**Incremental Sync Strategy:**
- Use `If-Modified-Since` header to fetch only changed records
- Store `last_sync_at` timestamp in organization table
- First sync: Fetch all records (no If-Modified-Since)
- Subsequent syncs: Only fetch records modified after last_sync_at
- [Source: external-apis.md#data-retrieval-patterns]

**Cron Schedule:**
```
0 */2 * * *
│ │  │ │ │
│ │  │ │ └─ Day of week (any)
│ │  │ └─── Month (any)
│ │  └───── Day of month (any)
│ └──────── Hour (every 2 hours: 0, 2, 4, 6, 8, 10, 12, 14, 16, 18, 20, 22)
└────────── Minute (at :00)
```
Executions: 12 times per day at 00:00, 02:00, 04:00, etc. (Sydney time)
[Source: deployment-architecture.md#n8n-workflow-configuration]

### Data Transformation Examples

**Invoice Transformation:**
```javascript
// n8n Function node
const invoice = $json;
const orgId = '<organization-uuid>'; // From workflow config

return {
  organization_id: orgId,
  source: 'xero',
  source_id: invoice.InvoiceID,
  transaction_type: invoice.Type === 'ACCREC' ? 'revenue' : 'expense',
  amount: parseFloat(invoice.Total),
  currency: invoice.CurrencyCode || 'AUD',
  transaction_date: invoice.Date.split('T')[0],
  due_date: invoice.DueDate?.split('T')[0],
  client_id: null, // Resolve from contacts table
  client_name: invoice.Contact.Name,
  account_code: invoice.LineItems[0]?.AccountCode,
  description: invoice.Reference,
  status: invoice.Status.toLowerCase(),
  metadata: JSON.stringify(invoice) // Store full Xero JSON
};
```
[Source: deployment-architecture.md#workflow-definition]

**Upsert Query:**
```sql
INSERT INTO financial_data (
  organization_id, source, source_id, transaction_type, amount,
  transaction_date, client_name, status, metadata, updated_at
)
VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, NOW())
ON CONFLICT (organization_id, source, source_id)
DO UPDATE SET
  amount = EXCLUDED.amount,
  status = EXCLUDED.status,
  metadata = EXCLUDED.metadata,
  updated_at = NOW();
```
[Source: database-schema.md#important-constraints]

### Sync Metadata Tables

**Schema for Tracking:**
```sql
CREATE TABLE sync_sessions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  organization_id UUID NOT NULL REFERENCES organizations(id),
  workflow_name VARCHAR(100),
  status VARCHAR(20) CHECK (status IN ('running', 'success', 'partial', 'failed')),
  started_at TIMESTAMP WITH TIME ZONE DEFAULT now(),
  completed_at TIMESTAMP WITH TIME ZONE,
  duration_seconds INTEGER,
  records_processed JSONB, -- {"invoices": 150, "contacts": 20, ...}
  errors JSONB,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT now()
);

CREATE TABLE sync_logs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  sync_session_id UUID REFERENCES sync_sessions(id),
  log_level VARCHAR(10) CHECK (log_level IN ('info', 'warn', 'error')),
  message TEXT,
  details JSONB,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT now()
);
```
[Source: database-schema.md]

### Error Handling Strategy

**Retry Logic:**
- Transient errors (network, rate limit): Retry 3 times, exponential backoff
- Authentication errors: Attempt token refresh, alert if fails
- Data errors (validation, constraint violations): Log and skip record
- Workflow errors: Mark sync as 'partial', continue with other endpoints
- [Source: external-apis.md#error-handling-rate-limiting]

**Notification Triggers:**
- 3 consecutive failed syncs → Alert admin
- Sync duration > 1 hour → Alert admin
- Authentication failure → Immediate alert
- Data freshness > 6 hours → Warning alert

### Performance Targets

**Baseline Expectations:**
- 500 invoices/sync: ~5 minutes
- 100 contacts/sync: ~1 minute
- 200 transactions/sync: ~2 minutes
- Total expected: 10-15 minutes for typical dataset
- Maximum allowed: 30 minutes (95th percentile)
- [Source: epic-1-foundation-data-pipeline-infrastructure.md#story-1.5]

**Optimization Techniques:**
- Batch inserts: 50-100 records per Supabase request
- Parallel execution: Contacts + Accounts simultaneously
- Skip unchanged records: Compare checksums before upsert
- Limit data: Only fetch last 90 days on first sync

### Testing

**Testing Standards:**

Functional and integration testing of ETL workflow with real Xero data.

**Test Execution:**

1. **Schedule Test (AC: 1):**
   - Verify cron trigger configured correctly
   - Wait for next scheduled execution
   - Check n8n execution history for automated run

2. **Full Sync Test (AC: 2, 3, 4):**
   - Execute workflow manually (first sync - no If-Modified-Since)
   - Verify all 7 endpoints extract data
   - Check Supabase tables for inserted records
   - Verify record counts match Xero data
   - Verify no duplicate records

3. **Incremental Sync Test (AC: 3, 4):**
   - Run initial sync
   - Create/modify 5 test invoices in Xero
   - Run sync again
   - Verify only 5 new/updated records processed
   - Check `last_sync_at` timestamp updated

4. **Error Handling Test (AC: 7):**
   - Simulate network failure during sync
   - Verify retry logic executes
   - Check error logs in `sync_logs` table
   - Verify notification sent

5. **Performance Test (AC: 6):**
   - Execute workflow with realistic dataset (500+ invoices)
   - Measure execution duration
   - Verify completion within 30 minutes
   - Check for performance bottlenecks

6. **7-Day Reliability Test (AC: 8):**
   - Enable scheduled workflow
   - Monitor for 7 consecutive days
   - Track success rate (target: 95%+)
   - Document any failures

**Test Documentation:**
- `docs/qa/1.5-etl-workflow-tests.md`

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-22 | 1.0 | Initial story creation from Epic 1 | Bob (Scrum Master) |

## Dev Agent Record

_This section will be populated by the development agent during implementation._

### Agent Model Used
_To be filled by Dev Agent_

### Debug Log References
_To be filled by Dev Agent_

### Completion Notes List
_To be filled by Dev Agent_

### File List
_To be filled by Dev Agent_

## QA Results

_This section will be populated by the QA Agent after implementation._
