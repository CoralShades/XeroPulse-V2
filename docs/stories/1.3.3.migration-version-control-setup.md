# Story 1.3.3: Setup Migration Version Control and Export Current Schema

## Status
**Draft**

## Story
**As a** database administrator,
**I want** all database schema changes tracked in version-controlled migration files,
**So that** schema can be reproduced in development, staging, and production environments.

## Acceptance Criteria

1. `supabase/migrations/` directory created in project repository
2. Current database schema exported to initial migration file
3. All 16 existing tables documented in migration files with proper DDL
4. Migration naming convention established: `YYYYMMDDHHMMSS_descriptive_name.sql`
5. Migration files committed to Git with proper .gitignore rules
6. README.md created in migrations directory with deployment instructions
7. Supabase CLI configured to track migrations locally and remotely
8. Rollback procedures documented for each migration

## Tasks / Subtasks

- [ ] **Task 1: Initialize Supabase Migration Structure** (AC: 1, 5)
  - [ ] Create directory: `mkdir -p supabase/migrations`
  - [ ] Initialize Supabase CLI in project:
    ```bash
    supabase init
    ```
  - [ ] Configure .gitignore:
    ```gitignore
    # Supabase
    supabase/.temp/
    supabase/.branches/
    **/supabase/.env
    ```
  - [ ] Verify directory structure:
    ```
    supabase/
    ├── config.toml
    ├── seed.sql
    └── migrations/
        └── (migration files will go here)
    ```

- [ ] **Task 2: Export Current Schema to Migration File** (AC: 2, 3)
  - [ ] Use Supabase CLI to generate schema diff:
    ```bash
    supabase db diff --schema public > supabase/migrations/20251030120000_initial_schema_export.sql
    ```
  - [ ] Manually review exported DDL for:
    - [ ] All 16 tables present (xero_*, profiles, dashboards, etc.)
    - [ ] Primary keys defined
    - [ ] Foreign keys included (xero_connections → auth.users, etc.)
    - [ ] RLS policies exported
    - [ ] Indexes included
    - [ ] CHECK constraints present
    - [ ] Comments preserved
  - [ ] Split into logical migration files if too large (optional):
    - [ ] `20251030120001_create_xero_tables.sql`
    - [ ] `20251030120002_create_dashboard_tables.sql`
    - [ ] `20251030120003_create_indexes.sql`
    - [ ] `20251030120004_enable_rls_policies.sql`

- [ ] **Task 3: Create Migration File Templates** (AC: 4)
  - [ ] Establish naming convention:
    ```
    Format: YYYYMMDDHHMMSS_descriptive_name.sql
    Examples:
    - 20251030120000_initial_schema_export.sql
    - 20251030130000_add_organizations_table.sql
    - 20251030140000_add_performance_indexes.sql
    ```
  - [ ] Create migration template file:
    ```sql
    -- Migration: [Name]
    -- Created: YYYY-MM-DD HH:MM:SS
    -- Description: [What this migration does]
    --
    -- Dependencies: [Previous migrations required]
    -- Impacts: [Tables/features affected]

    BEGIN;

    -- DDL statements here

    COMMIT;

    -- Rollback instructions:
    -- BEGIN;
    -- [Reverse DDL statements]
    -- COMMIT;
    ```
  - [ ] Add template to `supabase/migrations/TEMPLATE.sql`

- [ ] **Task 4: Document Migration History** (AC: 6)
  - [ ] Create `supabase/migrations/README.md`:
    ```markdown
    # Database Migrations

    ## Migration History
    - `20251015000001_create_bi_portal_schema.sql` - Initial Supabase setup
    - `20251030120000_initial_schema_export.sql` - Export of production schema

    ## Running Migrations
    ### Local Development
    ```bash
    supabase db reset  # Reset local DB
    supabase db push   # Apply all migrations
    ```

    ### Production Deployment
    ```bash
    supabase link --project-ref [project-ref]
    supabase db push
    ```

    ## Creating New Migrations
    ```bash
    supabase migration new [migration_name]
    # Edit generated file in supabase/migrations/
    supabase db push
    ```

    ## Rollback
    [Rollback procedures documented per migration]
    ```
  - [ ] Document connection instructions for local and production
  - [ ] Add troubleshooting section for common migration issues

- [ ] **Task 5: Reconcile Tracked Migration with Exported Schema** (AC: 2)
  - [ ] Review existing migration: `20251015000001_create_bi_portal_schema`
  - [ ] Compare with exported schema to identify gaps:
    ```bash
    supabase migration list  # Shows tracked migrations
    ```
  - [ ] Determine if additional tables were created outside migrations
  - [ ] Decision:
    - [ ] Option A: Squash into single comprehensive migration
    - [ ] Option B: Keep historical migration + add "schema sync" migration
  - [ ] Document decision rationale in migration comments

- [ ] **Task 6: Create Rollback Procedures** (AC: 8)
  - [ ] For each migration file, add rollback section:
    ```sql
    -- Rollback: 20251030120000_initial_schema_export.sql
    -- WARNING: This will DELETE ALL DATA
    -- Only use in development or with proper backups

    BEGIN;

    -- Drop tables in reverse dependency order
    DROP TABLE IF EXISTS xero_project_time_entries CASCADE;
    DROP TABLE IF EXISTS xero_project_expenses CASCADE;
    DROP TABLE IF EXISTS xero_projects CASCADE;
    -- ... all other tables

    COMMIT;
    ```
  - [ ] Create `rollback_procedures.md` with:
    - [ ] Step-by-step rollback for each migration
    - [ ] Data backup requirements before rollback
    - [ ] Verification steps after rollback
  - [ ] Test rollback on local database

- [ ] **Task 7: Configure Supabase CLI for Local Development** (AC: 7)
  - [ ] Link to production Supabase project:
    ```bash
    supabase link --project-ref [your-project-ref]
    ```
  - [ ] Test pulling remote schema:
    ```bash
    supabase db pull
    ```
  - [ ] Configure local development database:
    ```bash
    supabase start  # Starts local Supabase instance via Docker
    ```
  - [ ] Verify local migrations apply correctly:
    ```bash
    supabase db reset
    ```
  - [ ] Document local development workflow in README

- [ ] **Task 8: Commit to Version Control** (AC: 5)
  - [ ] Stage migration files:
    ```bash
    git add supabase/migrations/
    git add supabase/config.toml
    git add supabase/.gitignore
    ```
  - [ ] Commit with descriptive message:
    ```bash
    git commit -m "Story 1.3.3: Setup migration version control and export current schema

    - Export production schema to 20251030120000_initial_schema_export.sql
    - Create supabase/migrations/ directory structure
    - Add migration README with deployment instructions
    - Configure Supabase CLI for local development
    - Document rollback procedures

    Resolves: Story 1.3 AC#5 violation (MIGRATION-001)"
    ```
  - [ ] Push to remote:
    ```bash
    git push origin demi-xeropulse-v2
    ```
  - [ ] Verify files visible in GitHub/repository

- [ ] **Task 9: Validate Migration Reproducibility** (AC: 7)
  - [ ] Test on fresh local database:
    ```bash
    supabase db reset  # Wipes DB and reapplies all migrations
    ```
  - [ ] Verify all 16 tables created
  - [ ] Verify RLS policies active
  - [ ] Verify indexes present
  - [ ] Compare local schema to production:
    ```bash
    supabase db diff --linked
    # Should show "No schema differences"
    ```
  - [ ] Document any discrepancies found

## Dev Notes

### Migration Philosophy

**Why Version Control Migrations?**
1. **Reproducibility**: Any developer can recreate database locally
2. **Auditability**: Complete history of schema changes
3. **Collaboration**: Multiple developers can work on schema safely
4. **Deployment Safety**: Automated, tested deployments vs manual SQL
5. **Rollback Capability**: Can revert to previous schema state

### Supabase Migration System

**How Supabase Tracks Migrations:**
- Migrations stored in `supabase_migrations.schema_migrations` table
- Each migration applied once (tracked by filename)
- Migrations applied in alphanumeric order (hence YYYYMMDDHHMMSS prefix)
- `supabase db reset` reapplies all migrations from scratch

**Migration States:**
- **Pending**: File exists but not applied
- **Applied**: File tracked in schema_migrations table
- **Modified**: Applied file changed (dangerous! Create new migration instead)

### Current Schema Baseline

**As of 2025-10-30 (from QA review):**
- 16 tables created
- 1 tracked migration: `20251015000001_create_bi_portal_schema`
- Gap: 15 tables created outside migrations (manual or UI creation)

**This Story Addresses:**
- Export all 16 tables to migration files
- Establish going-forward migration discipline
- Enable local development with Docker-based Supabase

### Migration Best Practices

**DO:**
- ✅ Use transactions (BEGIN/COMMIT) for atomic changes
- ✅ Test migrations on local DB before production
- ✅ Add comments explaining WHY, not just WHAT
- ✅ Include rollback instructions
- ✅ Name files descriptively
- ✅ Keep migrations small and focused

**DON'T:**
- ❌ Modify applied migrations (create new one instead)
- ❌ Delete migration files (breaks reproducibility)
- ❌ Skip testing on local DB first
- ❌ Hardcode data (use seed.sql instead)
- ❌ Commit sensitive credentials to migration files

### Seed Data vs Migrations

**Migrations**: Schema changes (DDL)
```sql
-- In supabase/migrations/YYYYMMDD_*.sql
CREATE TABLE organizations (...);
```

**Seed Data**: Initial data (DML)
```sql
-- In supabase/seed.sql
INSERT INTO organizations (name, xero_tenant_id)
VALUES ('Demo Org', 'demo-tenant-123');
```

**This Story**: Focuses on schema migrations. Test data belongs in seed.sql (separate story).

## Testing

**Testing Standards:**
Infrastructure validation - migration must be reproducible.

**Test Plan:**

1. **Fresh Database Test**:
   ```bash
   # Start fresh Supabase instance
   supabase start
   supabase db reset

   # Verify all tables exist
   psql "postgres://postgres:postgres@localhost:54322/postgres" \
     -c "\dt public.*"

   # Should show 16 tables
   ```

2. **Schema Comparison Test**:
   ```bash
   # Link to production
   supabase link --project-ref [prod-ref]

   # Check for differences
   supabase db diff --linked

   # Should show "No schema differences"
   # If differences exist, update migration to match production
   ```

3. **Rollback Test**:
   ```bash
   # Apply migrations
   supabase db reset

   # Apply rollback SQL
   psql "postgres://postgres:postgres@localhost:54322/postgres" \
     -f rollback_procedures/20251030120000_rollback.sql

   # Verify tables dropped
   ```

4. **Idempotency Test**:
   ```bash
   # Run migrations twice
   supabase db reset
   supabase db reset

   # Should succeed both times (idempotent)
   # No errors about "table already exists"
   ```

**Success Criteria:**
- ✅ Fresh local DB matches production schema
- ✅ All 16 tables created via migrations
- ✅ RLS policies active
- ✅ Indexes present
- ✅ No manual SQL required

## Dependencies

**Blocks:**
- Team collaboration: Developers cannot sync local DB without migrations
- Future schema changes: All changes must go through migrations going forward
- Production deployments: Automated deployment requires version-controlled migrations

**Depends On:**
- Story 1.3: Supabase database schema (completed)

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-30 | 1.0 | Created from QA review findings (Story 1.3 MIGRATION-001) | Quinn (QA) |

## Implementation Notes

**Estimated Effort**: 2-3 hours
- 1 hour: Export schema + create migration files
- 30 minutes: Write README and documentation
- 30 minutes: Test on local database
- 30 minutes: Commit to Git + verify

**Risk Assessment**: Low
- Risk: Exported schema may have syntax errors
- Mitigation: Test on local DB before committing
- Risk: Git conflicts with other developers
- Mitigation: Coordinate migration creation, use descriptive filenames

**Production Impact**: None
- This story only creates documentation/files
- No changes to production database
- Enables future controlled deployments

**Next Steps After This Story:**
1. All future schema changes go through migration files
2. Developers use `supabase db reset` to sync local DB
3. Production deployments use `supabase db push` (automated)
