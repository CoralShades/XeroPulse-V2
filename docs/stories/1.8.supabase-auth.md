# Story 1.8: Implement Basic Authentication with Supabase Auth

## Status
**Draft**

## Story
**As a** platform administrator,
**I want** secure email/password authentication enabled,
**So that** only authorized users can access dashboards via Next.js portal.

## Acceptance Criteria

1. Supabase Auth enabled with email/password provider configured
2. User table created in Supabase with fields: `id`, `email`, `role` (enum: executive, manager, staff), `created_at`, `last_login`
3. Password policies configured: Minimum 8 characters, requires uppercase, lowercase, number
4. Password reset workflow enabled via Supabase Auth (email-based reset link)
5. Test users created for 3 roles: 1 executive, 1 manager, 1 staff (for development/testing)
6. Session management configured: JWT tokens with 24-hour expiration, refresh token enabled
7. Security: Passwords hashed via bcrypt (Supabase default), credentials stored securely
8. Authentication tested: Login successful, logout clears session, password reset flow completes end-to-end

## Tasks / Subtasks

- [ ] **Task 1: Enable Supabase Auth** (AC: 1, 3)
  - [ ] Access Supabase dashboard â†’ Authentication
  - [ ] Enable email/password provider
  - [ ] Configure password policy (min 8 chars, uppercase, lowercase, number)
  - [ ] Enable email confirmations (optional for MVP)
  - [ ] Configure JWT expiry: 24 hours

- [ ] **Task 2: Create/Update Users Table** (AC: 2)
  - [ ] Add migration for users table (if not exists from Story 1.3)
  - [ ] Add fields: `id`, `email`, `role`, `created_at`, `last_login`
  - [ ] Add role enum constraint
  - [ ] Add trigger to update `last_login` on authentication

- [ ] **Task 3: Configure Password Reset** (AC: 4)
  - [ ] Enable password reset emails in Supabase
  - [ ] Configure reset email template
  - [ ] Set reset link expiration (1 hour)
  - [ ] Test password reset flow

- [ ] **Task 4: Create Test Users** (AC: 5)
  - [ ] Create executive test user
  - [ ] Create manager test user
  - [ ] Create staff test user
  - [ ] Document test credentials

- [ ] **Task 5: Configure Session Management** (AC: 6)
  - [ ] Set JWT expiry to 24 hours
  - [ ] Enable refresh tokens
  - [ ] Configure session timeout behavior

- [ ] **Task 6: Test Authentication Flows** (AC: 8)
  - [ ] Test login with valid credentials
  - [ ] Test login with invalid credentials
  - [ ] Test logout
  - [ ] Test password reset end-to-end
  - [ ] Test session expiry and refresh

## Dev Notes

### Supabase Auth Configuration

**Password Policy:**
- Min length: 8 characters
- Require: uppercase, lowercase, number
- Optional: special character (not enforced in MVP)
- [Source: security-architecture.md#authentication-identity-management]

**Session Configuration:**
- JWT expiry: 24 hours (86400 seconds)
- Refresh token: Enabled
- Auto-refresh: Enabled in client SDK
- [Source: security-architecture.md#session-management-security]

### Users Table Schema

```sql
-- Already created in Story 1.3, verify/update if needed
CREATE TABLE users (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  email VARCHAR(255) UNIQUE NOT NULL,
  role VARCHAR(20) NOT NULL CHECK (role IN ('executive', 'manager', 'staff', 'admin')),
  organization_id UUID NOT NULL REFERENCES organizations(id),
  active BOOLEAN DEFAULT true,
  last_login TIMESTAMP WITH TIME ZONE,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT now(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT now()
);

-- Trigger to update last_login
CREATE OR REPLACE FUNCTION update_last_login()
RETURNS TRIGGER AS $$
BEGIN
  UPDATE users SET last_login = NOW() WHERE id = NEW.id;
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER on_auth_user_created
  AFTER INSERT ON auth.users
  FOR EACH ROW
  EXECUTE FUNCTION update_last_login();
```
[Source: database-schema.md#users-authentication]

### Test User Credentials

```
Executive: exec@xeropulse.test / TestPass123
Manager: manager@xeropulse.test / TestPass123
Staff: staff@xeropulse.test / TestPass123
```

### Testing

**Test Execution:**
1. Login test (valid/invalid credentials)
2. Logout test
3. Password reset test
4. Session expiry test
5. Token refresh test

**Test Documentation:**
- `docs/qa/1.8-auth-tests.md`

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-22 | 1.0 | Initial story creation from Epic 1 | Bob (Scrum Master) |

## Dev Agent Record

_This section will be populated by the development agent during implementation._

## QA Results

_This section will be populated by the QA Agent after implementation._
