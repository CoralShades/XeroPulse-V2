# Story 1.8: Configure Supabase Auth Backend and RLS Policies

## Status
**Draft**

## Story
**As a** platform administrator,
**I want** Supabase Auth backend configured with role-based access control and Row Level Security policies,
**So that** users can securely authenticate and access only their authorized data.

**Note:** Frontend auth UI is already implemented in Story 1.0 (Next.js + Vercel template). This story focuses on backend Supabase configuration and security policies.

## Acceptance Criteria

1. Supabase Auth enabled with email/password provider configured
2. User table verified/updated in Supabase with fields: `id`, `email`, `role` (enum: executive, manager, staff, admin), `organization_id`, `active`, `created_at`, `last_login`
3. Password policies configured: Minimum 8 characters, requires uppercase, lowercase, number
4. Password reset workflow enabled via Supabase Auth (email-based reset link)
5. Row Level Security (RLS) policies enabled on all user-facing tables: `users`, `financial_data`, `project_data`, `dashboard_configs`
6. Organization isolation policy created: Users can only access data from their own organization
7. Role-based access policies created: Staff users restricted to assigned clients, managers to departments, executives to all org data
8. Test users created for 4 roles: 1 executive, 1 manager, 1 staff, 1 admin (for development/testing)
9. Session management configured: JWT tokens with 8-hour expiration (per architecture), refresh token enabled
10. RLS policies tested: Verify users cannot access other organizations' data, staff users see only assigned clients
11. Authentication tested: Login successful, logout clears session, password reset flow completes end-to-end, RLS enforced

## Tasks / Subtasks

- [ ] **Task 1: Enable Supabase Auth** (AC: 1, 3)
  - [ ] Access Supabase dashboard â†’ Authentication
  - [ ] Enable email/password provider
  - [ ] Configure password policy (min 8 chars, uppercase, lowercase, number)
  - [ ] Enable email confirmations (optional for MVP)
  - [ ] Configure JWT expiry: 24 hours

- [ ] **Task 2: Create/Update Users Table** (AC: 2)
  - [ ] Add migration for users table (if not exists from Story 1.3)
  - [ ] Add fields: `id`, `email`, `role`, `created_at`, `last_login`
  - [ ] Add role enum constraint
  - [ ] Add trigger to update `last_login` on authentication

- [ ] **Task 3: Configure Password Reset** (AC: 4)
  - [ ] Enable password reset emails in Supabase
  - [ ] Configure reset email template
  - [ ] Set reset link expiration (1 hour)
  - [ ] Test password reset flow

- [ ] **Task 4: Create Test Users** (AC: 5)
  - [ ] Create executive test user
  - [ ] Create manager test user
  - [ ] Create staff test user
  - [ ] Document test credentials

- [ ] **Task 5: Configure Session Management** (AC: 9)
  - [ ] Set JWT expiry to 8 hours (28800 seconds) per architecture spec
  - [ ] Enable refresh tokens
  - [ ] Configure auto-refresh at 30 minutes before expiry
  - [ ] Configure session timeout behavior

- [ ] **Task 6: Implement Row Level Security Policies** (AC: 5, 6, 7)
  - [ ] Enable RLS on `users` table
  - [ ] Enable RLS on `financial_data` table
  - [ ] Enable RLS on `project_data` table
  - [ ] Enable RLS on `dashboard_configs` table
  - [ ] Create organization isolation policy
  - [ ] Create role-based access policies (executive, manager, staff, admin)
  - [ ] Verify policies syntax is correct

- [ ] **Task 7: Create Test Users** (AC: 8)
  - [ ] Create executive test user
  - [ ] Create manager test user
  - [ ] Create staff test user
  - [ ] Create admin test user
  - [ ] Assign organizations to each test user
  - [ ] Assign staff user to specific clients (for RLS testing)
  - [ ] Document test credentials

- [ ] **Task 8: Test RLS Policies** (AC: 10)
  - [ ] Log in as executive user, verify sees all org data
  - [ ] Log in as manager user, verify sees department data
  - [ ] Log in as staff user, verify sees only assigned clients
  - [ ] Attempt cross-organization access (should fail)
  - [ ] Verify RLS policies block unauthorized queries

- [ ] **Task 9: Test Authentication Flows** (AC: 11)
  - [ ] Test login with valid credentials (all 4 roles)
  - [ ] Test login with invalid credentials
  - [ ] Test logout clears session
  - [ ] Test password reset end-to-end
  - [ ] Test session expiry and refresh
  - [ ] Verify Next.js portal (Story 1.0) integrates correctly

## Dev Notes

### Story Scope Clarification

**What Story 1.0 Already Provides:**
- âœ… Next.js frontend auth UI (login, signup, logout pages)
- âœ… Supabase client configuration
- âœ… Auth middleware for protected routes
- âœ… Frontend session management
- [Source: Story 1.0]

**What This Story (1.8) Adds:**
- ðŸ”§ Supabase Auth backend configuration (password policies, JWT settings)
- ðŸ”§ Row Level Security (RLS) policies for data isolation
- ðŸ”§ Organization and role-based access control
- ðŸ”§ Test user creation with role assignments
- ðŸ”§ Backend security validation
- [Source: security-architecture.md]

### Supabase Auth Configuration

**Password Policy:**
- Min length: 8 characters (can increase to 12 for production)
- Require: uppercase, lowercase, number
- Optional: special character (not enforced in MVP)
- Password hashing: bcrypt (Supabase default)
- [Source: security-architecture.md#authentication-identity-management]

**Session Configuration:**
- JWT expiry: 8 hours (28800 seconds) - **CORRECTED from 24 hours**
- Refresh token: Enabled
- Auto-refresh: 30 minutes before expiry
- Session timeout: 8 hours
- [Source: CLAUDE.md#session-management, security-architecture.md#session-management-security]

### Users Table Schema

```sql
-- Already created in Story 1.3, verify/update if needed
CREATE TABLE users (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  email VARCHAR(255) UNIQUE NOT NULL,
  role VARCHAR(20) NOT NULL CHECK (role IN ('executive', 'manager', 'staff', 'admin')),
  organization_id UUID NOT NULL REFERENCES organizations(id),
  active BOOLEAN DEFAULT true,
  last_login TIMESTAMP WITH TIME ZONE,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT now(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT now()
);

-- Trigger to update last_login
CREATE OR REPLACE FUNCTION update_last_login()
RETURNS TRIGGER AS $$
BEGIN
  UPDATE users SET last_login = NOW() WHERE id = NEW.id;
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER on_auth_user_created
  AFTER INSERT ON auth.users
  FOR EACH ROW
  EXECUTE FUNCTION update_last_login();
```
[Source: database-schema.md#users-authentication]

### Row Level Security (RLS) Policies

**Organization Isolation Policy:**
```sql
-- Enable RLS on financial_data table
ALTER TABLE financial_data ENABLE ROW LEVEL SECURITY;

-- Organization isolation policy
CREATE POLICY "org_isolation_financial_data" ON financial_data
  FOR ALL USING (
    organization_id IN (
      SELECT organization_id FROM users
      WHERE id = auth.uid()
    )
  );
```

**Role-Based Access Policies:**
```sql
-- Staff user policy: Only see assigned clients
CREATE POLICY "staff_client_access" ON financial_data
  FOR SELECT USING (
    CASE
      WHEN (SELECT role FROM users WHERE id = auth.uid()) = 'staff' THEN
        client_id IN (
          SELECT client_id FROM user_client_assignments
          WHERE user_id = auth.uid()
        )
      ELSE true
    END
  );

-- Manager policy: See department data
CREATE POLICY "manager_department_access" ON financial_data
  FOR SELECT USING (
    CASE
      WHEN (SELECT role FROM users WHERE id = auth.uid()) = 'manager' THEN
        client_id IN (
          SELECT client_id FROM clients
          WHERE assigned_manager_id = auth.uid()
        )
      ELSE true
    END
  );

-- Executive and Admin: See all org data (covered by org_isolation policy)
```
[Source: security-architecture.md#authorization-access-control, database-schema.md]

**RLS Policy for Users Table:**
```sql
ALTER TABLE users ENABLE ROW LEVEL SECURITY;

-- Users can only see other users in their organization
CREATE POLICY "org_user_visibility" ON users
  FOR SELECT USING (
    organization_id IN (
      SELECT organization_id FROM users WHERE id = auth.uid()
    )
  );

-- Users can update their own profile
CREATE POLICY "user_self_update" ON users
  FOR UPDATE USING (id = auth.uid());
```

### Test User Credentials

**Test Organization:** Acme Accounting (from Story 1.3)

```
Executive: exec@xeropulse.test / TestPass123! (role: executive)
Manager: manager@xeropulse.test / TestPass123! (role: manager)
Staff: staff@xeropulse.test / TestPass123! (role: staff)
Admin: admin@xeropulse.test / TestPass123! (role: admin)
```

**RLS Test Setup:**
- All test users belong to same organization
- Staff user assigned to 2 specific clients
- Manager user assigned to "Finance Department"
- Executive and Admin see all organization data

### Dependencies

**Depends On:**
- Story 1.0: Next.js project with auth UI (frontend integration point)
- Story 1.3: Supabase database schema with users table

**Enables:**
- Story 1.9: Dashboard embedding (auth backend ready)
- Epic 2: All portal features (RBAC and RLS in place)

**Integration with Story 1.0:**
- Story 1.0 provides frontend auth UI using Vercel template
- This story (1.8) configures the Supabase backend that Story 1.0 connects to
- Next.js middleware from Story 1.0 will enforce RLS policies configured here
- JWT tokens issued by this story's config will be used by Story 1.0's auth flow

### Testing

**Testing Standards:**

Backend configuration validation and RLS policy testing using Supabase dashboard and SQL queries.

**Testing Approach:**
- Supabase Auth configuration verification
- RLS policy validation
- Role-based access testing
- Cross-organization access prevention
- Integration testing with Story 1.0 frontend

**Test Execution:**

1. **Auth Configuration Test (AC: 1, 3, 4):**
   - Access Supabase dashboard â†’ Authentication
   - Verify email/password provider enabled
   - Check password policy settings (min 8 chars, uppercase, lowercase, number)
   - Verify password reset emails configured
   - Test password reset flow manually

2. **Users Table Test (AC: 2):**
   ```sql
   -- Verify users table structure
   SELECT column_name, data_type, is_nullable
   FROM information_schema.columns
   WHERE table_name = 'users';

   -- Verify role constraint
   SELECT constraint_name, check_clause
   FROM information_schema.check_constraints
   WHERE constraint_name LIKE '%role%';
   ```

3. **RLS Policies Test (AC: 5, 6, 7, 10):**
   ```sql
   -- Verify RLS is enabled
   SELECT tablename, rowsecurity
   FROM pg_tables
   WHERE schemaname = 'public'
   AND tablename IN ('users', 'financial_data', 'project_data', 'dashboard_configs');

   -- List all RLS policies
   SELECT schemaname, tablename, policyname, cmd, qual
   FROM pg_policies
   WHERE schemaname = 'public';
   ```

4. **Organization Isolation Test (AC: 6):**
   - Create test data for 2 organizations
   - Log in as user from Organization A
   - Query financial_data table
   - Verify only Organization A data returned
   - Attempt to query Organization B data by ID (should return empty or error)

5. **Role-Based Access Test (AC: 7, 10):**
   - **Executive Test:**
     ```sql
     -- Log in as executive@xeropulse.test
     SELECT COUNT(*) FROM financial_data; -- Should see all org data
     ```
   - **Manager Test:**
     ```sql
     -- Log in as manager@xeropulse.test
     SELECT COUNT(*) FROM financial_data; -- Should see department data only
     ```
   - **Staff Test:**
     ```sql
     -- Log in as staff@xeropulse.test
     SELECT COUNT(*) FROM financial_data; -- Should see assigned clients only
     SELECT client_id FROM financial_data; -- Verify only assigned client IDs
     ```

6. **Test User Creation Test (AC: 8):**
   - Verify all 4 test users created in Supabase Auth
   - Check users table has corresponding records
   - Verify roles assigned correctly
   - Test login with each user

7. **Session Management Test (AC: 9):**
   - Log in and capture JWT token
   - Decode JWT and verify expiry is 8 hours from issue time
   - Wait for token to expire (or manipulate system time)
   - Verify refresh token renews session
   - Check auto-refresh triggers at 7.5 hours

8. **Integration Test with Story 1.0 (AC: 11):**
   - Access Next.js portal from Story 1.0
   - Log in using Supabase Auth configured in this story
   - Verify session created and stored
   - Navigate to protected route
   - Verify middleware enforces auth
   - Log out and verify session cleared

**Test Documentation:**
- Document all test results in `docs/qa/1.8-auth-backend-tests.md`
- Include SQL query results
- Screenshot RLS policy violations (expected errors)
- Record JWT token structure and expiry
- Document integration test with Story 1.0

**Testing Tools:**
- Supabase dashboard (Authentication, Database, SQL Editor)
- SQL queries for RLS validation
- JWT decoder (jwt.io) for token inspection
- Browser DevTools for session/cookie inspection
- Postman/curl for API testing

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-22 | 1.0 | Initial story creation from Epic 1 | Bob (Scrum Master) |
| 2025-10-22 | 1.1 | Updated to focus on backend config and RLS, clarified scope vs Story 1.0 | Sarah (Product Owner) |

## Dev Agent Record

_This section will be populated by the development agent during implementation._

## QA Results

_This section will be populated by the QA Agent after implementation._
